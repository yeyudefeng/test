===========================
tb_school_device
===========================
select 
  data_id  -- '数据编号'
  ,device_no  -- '设备编号'
  ,device_type   -- '设备类型见 tb_all_type.type_id'
  ,school_id   -- '校园的机构id'
  ,position_type  -- '位置类型(1-教室、2-室内公共区、3-室外公共区)'
  ,position_id  -- '设备位置Id'
  ,bind_time  -- '绑定时间'
from db_campus_education.tb_school_device;


===========================
tb_student
===========================
select 
  student_id    -- '学生id'
  ,org_id    -- '学校id'
  ,class_id    -- '班级id'
  ,status     -- '学生状态（0-停用 1-正常 2-毕业 3-结业）'
  ,deleted     -- '删除 0-已删除 1-正常'
  ,student_name   -- '姓名'
  ,parent_name   -- '家长姓名'
  ,student_no   -- '学号'
  ,sex   -- '1-男 2-女 3-其他'
  ,birthday   -- '出生日期'
  ,card_no   -- '身份证号码'
  ,home_address   -- '家庭地址'
  ,enter_school_date   -- '入学日期'
  ,create_time   -- '创建时间'
  ,update_time   -- '修改时间'
  ,card_type   -- '证件类型'
  ,nation   -- '民族'
  ,avatar   -- '头像'
  ,`user_id`   -- '关联家长用户id'
  ,province_id   -- '省份id'
  ,city_id   -- '城市id'
  ,area_id   -- '区县id'
  ,province_city_area   -- '省市区'
from db_campus_education.tb_student 
where STR_TO_DATE(update_time,'%Y-%m-%d')<STR_TO_DATE(now(),'%Y-%m-%d');  


===========================
tb_class
===========================
select 
  class_id   -- '班级id'
  ,class_no   -- '班级编号'
  ,class_name   -- '班级名称'
  ,grade_id   -- '年级id'
  ,grade_name   -- '年级名称'
  ,org_id   -- '学校id'
  ,status    -- '班级状态（0-失效 1-正常 2-毕业）'
  ,enter_school_year   -- '入学年份'
  ,leave_date   -- '毕业离园日期'
  ,graduation_time   -- '毕业处理时间'
  ,create_time   -- '添加时间'
  ,update_time   -- '修改时间'
from db_campus_education.tb_class
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_grade
===========================
select 
  data_id    -- '主键标识'
  ,grade_id  -- '年级id'
  ,org_id   -- '学校id'
  ,grade_name  -- '年级名称'
  ,grade_order  -- '年级排序'
  ,create_time  -- '添加时间'
  ,update_time  -- '失效日期'
from db_campus_education.tb_grade 
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_org
===========================
select 
  org_id    -- '机构id'
  ,org_name   -- '机构名称'
  ,domain_name   -- '机构专属域名'
  ,admin_user_id    -- '机构管理员的用户id'
  ,parent_id     -- '上级机构id0表示没有上级机构'
  ,org_type   -- '机构类型( 1:教育局 2:教育集团 3:幼儿园)'
  ,grade_ids   -- '幼儿园开设年级以英文逗号隔开'
  ,org_code   -- '机构代码'
  ,status    -- '状态(-1:未开始 0:停用 1：正常 2：过期)'
  ,deleted    -- '删除状态 0已删除 1正常'
  ,create_time   -- '创建时间'
  ,update_time   -- '更新时间'
  ,start_date   -- '使用期限的开始时间'
  ,end_date   -- '使用期限的结束时间'
  ,logo   -- 'logo图标路径'
  ,province_id   -- '省份id'
  ,city_id   -- '城市id'
  ,area_id   -- '区县id'
  ,province_city_area   -- '省市区'
  ,address   -- '详细地址'
  ,fixed_tel_area_num   -- '固定电话-区号'
  ,fixed_tel_num   -- '固定电话号码'
  ,phone_num   -- '联系手机'
from db_campus_education.tb_org 
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_config
===========================
select 
 data_id         -- '唯一标识id'
,serial_number   -- '序号'
,name            -- '名称'
,group_id        -- '分组id'
,group_name      -- '分组名称'
from db_campus_platform.tb_config;


===========================
tb_student_health_file
===========================
select 
  data_id                                    -- '唯一标识'
  ,student_data_id                            -- '学生id'
  ,history_of_convulsions                     -- '高热惊厥史0：无，1：有'
  ,attack_temp                                -- '发作时温度'
  ,number_of_attacks                          -- '发作次数'
  ,serious_disease_history                    -- '各种严重病史，0：无，1：有'
  ,serious_disease_history_details            -- '严重病史详情'
  ,infectious_disease_history                 -- '各种传染病史，0：无，1：有'
  ,infectious_disease_history_details         -- '传染病史详情'
  ,other_infectious_disease_history           -- ' 其他传染病史'
  ,weight 								     -- '体重（单位：kg）'
  ,weight_assess 						     -- '0：中上，1：中等，2：中下'
  ,height 								     -- '身高（单位：cm）'
  ,height_assess 							 -- '0：中上，1：中等，2：中下'
  ,bmi 									     -- 'bmi数值'
  ,bmi_assess 								 -- '0：中上，1：中等，2：中下'
  ,left_eye 									 -- '0:未检查，1：正常，2：砂眼，3：结膜炎'
  ,right_eye 								 -- '0:未检查，1：正常，2：砂眼，3：结膜炎'
  ,left_vision 								 -- '左视力'
  ,right_vision 								 -- '右视力'
  ,number_of_caries 							 -- '龋齿数“”空字符串为未检测'
  ,number_of_teeth 							 -- '牙齿数量'
  ,head_neck 								 -- ' 头颈，0：未检测，1：正常，2：异常'
  ,thoracic									 -- '胸廓，0：未检测，1：正常，2：异常'
  ,spine 									 -- '脊椎，0：未检测，1:正常，2：异常'
  ,limbs 									 -- '四肢，0：未检测，1:正常，2：异常'
  ,pharynx 									 -- '咽部，0：未检测，1：正常，2：异常'
  ,heart 									 -- '心，0：未检测，1：正常，2：异常'
  ,lung 										 -- '肺，0：未检测，1：正常，2：异常'
  ,liver 									 -- '肝，0：未检测，1：正常，2：异常'
  ,spleen 									 -- '脾，0：未检测，1：正常，2异常'
  ,hemoglobin 								 -- '血红蛋白（单位：g/h）'
  ,alt 										 -- '丙氨酸氨基转移酶，0：未检测，1：正常，2：异常'
  ,complete 									 -- '1：齐全，0：不齐'
  ,lack 										 -- '0：卡芥兰，1：乙肝，2：麻疹，3：骨髓灰质炎，4：百白破，5：乙脑'
  ,create_time 								 -- '创建时间'
  ,whether_allergy 							 -- '是否过敏体质，0：否，1：是'
  ,status 									 -- '0：失效，1：正常，2：停用'
  ,update_time 								 -- '更新时间'
  ,`resource` 								 -- '0:健康档案，1：健康体检复制内容'
  ,checkup_id 								 -- '体检id'
  ,deleted 									 -- '0：删除，1：正常'
from   db_campus_platform.tb_student_health_file 
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_robot_check_report
===========================
select 
 data_id            -- '主键标识'
,device_id          -- '设备ID'
,mac_address        -- 'MAC地址'
,product_id         -- '产品标识'
,student_id    -- '学生唯一标识'
,data_time          -- '数据日期'
,card_no            -- '卡号'
,measure_time       -- '测量时间'
,temperature        -- '体温'
,level              -- '体温状态'
,hand               -- '手部异常'
,mouth              -- '口腔异常'
,red_eye            -- '红眼'
,fever              -- '发烧'
,cheek              -- '腮部肿大'
,spirit             -- '精神不佳'
,throat             -- '咽炎'
,trauma             -- '外伤'
,cough              -- '咳嗽'
,fingernail         -- '指甲过长'
,tooth_decay        -- '蛀牙'
,other              -- '其他异常'
,hand_img           -- '手部异常图像'
,mouth_img          -- '口腔异常图像'
,eye_img            -- '眼睛异常图像'
,data_type          -- '数据类型'
,abnormal_num       -- '异常数量'
,upload_time        -- '上传时间'
,`access`             -- '是否允许入园(Y-是、N-否)'
from db_campus_platform.tb_robot_check_report
where str_to_date(upload_time,'%Y-%m-%d') = date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_vision_data
===========================
select
 vision_id           -- '主键标识'
,student_id   -- '学生唯一标识'
,left_vision       -- '左眼视力'
,right_vision      -- '右眼视力'
,left_abnormal     -- '左眼情况'
,right_abnormal    -- '右眼情况'
,source            -- '数据来源'
,measure_time      -- '测量日期'
,upload_time       -- '上传时间'
from  db_campus_platform.tb_vision_data
where str_to_date(upload_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_water_drink_record
===========================
select  
  data_id  				  	-- '自增主键'
  ,student_id 				-- '学生唯一ID'
  ,order_id 				-- '刷卡时间+卡号'
  ,device_no 				-- '设备编号'
  ,cdate 				  	-- '刷卡时间'
  ,card_no 				-- '卡号'
  ,water_amount 			-- '出水量ml'
  ,is_auto 					-- '1-净饮机 2-手动添加'
  ,intds 					-- '进水TDS'
  ,outtds 					-- '出水TDS'
  ,temperature 				-- '饮水温度'
  ,time_integer 			-- '时分秒的整数'
  ,school_id 				-- '学校ID'
  ,device_type 				-- '净饮机类型：1-海豚净饮机，2-易水香净饮机，3-碧丽水机，4-米越取水刷卡器'
  ,create_time 			  	-- '创建时间'
  ,device_position 		 	-- '饮水机位置'
  ,data_time                -- '刷卡日期'
from  db_campus_platform.tb_water_drink_record
where str_to_date(create_time,'%Y-%m-%d') = date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_sleep_day_data
===========================
select
  data_id 			  -- '主键'
  ,device_no 		  -- '设备编号'
  ,student_id 		  -- '学生id'
  ,`date` 			  -- '数据所在日期'
  ,sleep_duration 	  -- '睡眠时长（秒）'
  ,wake_duration 	  -- '清醒时长（秒）'
  ,wake_number 		  -- '清醒次数'
  ,score 			  -- '睡眠打分'
  ,source 			  -- '数据来源(1-天波手环，3-睡眠带子)'
  ,upload_time 		  -- '上传时间(utc)'
  ,create_time 		  -- '创建时间'
from  db_campus_platform.tb_sleep_day_data
where str_to_date(upload_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_sleep_day_status
===========================
select
 device_no 			   -- '设备id'
 ,student_id 		   -- '学生id'
 ,`date` 			   -- '数据所在日期'
 ,start_time 		   -- '睡眠状态开始时间(utc)'
 ,status 			   -- '睡眠状态（1-上床，2-入睡，3-浅睡，4-深睡，5-清醒，6-睡着，7-离床，8-再次上床，9-中途起床，10-微觉醒）'
 ,source 			   -- '数据来源(1-天波手环，2-米越手环，3-睡眠带子)'
from  db_campus_platform.tb_sleep_day_status
where str_to_date(start_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_sports_day_data
===========================
select
 data_id            -- '主键标识'
,student_id    -- '学生唯一标识'
,data_time          -- '日期'
,null as class_id           -- '班级唯一标识'
,amount             -- '步数'
,update_time        -- '更新时间'
,source
from  db_campus_platform.tb_sports_day_data
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_fresh_air_machine_run_data
===========================
select
 data_id                   -- '主键标识'
,device_no                 -- '设备标识'
,school_id                 -- '学校id'
,air_intake_state          -- '设备状态（0-关闭 1-开启）'
,air_intake_value_state    -- '风量大小（0-9）'
,air_exhaust_value_state   -- '排风风量（0-9）'
,heat_state                -- '辅热状态（0-关闭 1-开启）'
,air_intake_temp           -- '进风口温度（0~80）°C'
,air_intake_humidity       -- '进风口湿度（0~100）(%RH)'
,air_exhaust_temp          -- '出风口温度（0~80）°C'
,air_exhaust_humidity      -- '出风口湿度（0~100）(%RH)'
,co2_value                 -- 'co2值（0~5000）（ppm'
,pm25_value                -- 'PM2.5值（0~1000）（μg/m3）'
,formaldehyde_value        -- '甲醛浓度（0~5000）（mg/m3）'
,air_fresh_value           -- '空气清新指数(0-9)'
,create_time               -- '数据上传时间（北京时间）'
,upload_time               -- '修改时间'
from  db_campus_platform.tb_fresh_air_machine_run_data
where str_to_date(upload_time,'%Y-%m-%d') = date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_student_attendance_daily
===========================
select
  record_id 		 -- '记录ID'
  ,org_id			 -- '机构id'
  ,student_id 		 -- '学生唯一标识'
  ,data_time 		 -- '数据日期'
  ,class_id 			 -- '班级唯一标识'
  ,am_card_time 		 -- '入园时间(HH:mm)'
  ,pm_card_time 		 -- '离园时间(HH:mm)'
  ,`result` 			 -- '状态(1-正常出席、2-缺席、3-病假、4-事假、5-未入园、6-空)'
  ,content 			 -- '内容'
  ,update_time 		 -- '更新时间'
  ,update_by_user 	 -- '更新人'
  ,card_url 			 -- '打卡图片'
  ,am_url 			 -- '打卡图片-入园'
  ,pm_url 			 -- '打卡图片-离园'
from  db_campus_platform.tb_student_attendance_daily
where str_to_date(update_time,'%Y-%m-%d') = date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_student_leave
===========================
select
  leave_id 				-- '请假记录id'
  ,student_id 			-- '学生唯一标识'
  ,leave_type 			-- '请假类型:2-病假,3-事假'
  ,leave_reason 			-- '请假事由'
  ,leave_url 			-- '病况资料图片url，多个url使用逗号","间隔'
  ,leave_duration 		-- '请假时长（单位：天）'
  ,start_time 			-- '开始时间'
  ,end_time 				-- '结束时间'
  ,start_time_type 		-- '请假开始时间类型：0-上午 1-下午'
  ,end_time_type 		-- '请假结束时间类型：0-上午 1-下午'
  ,teacher_data_id 		-- '审批老师主键ID'
  ,read_status 			-- '阅读状态：1-未读，2-已读'
  ,approve_status 		-- '审批状态：1-未处理，2-已处理'
  ,approve_date 			-- '审批时间'
  ,status 				-- '状态：0-家长撤销；1-提交成功 ; 2-老师撤销'
  ,create_date 			-- '创建时间'
  ,update_date 			-- '修改时间'
  ,org_id 				-- '学校id'
from  db_campus_platform.tb_student_leave
where str_to_date(update_date,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_disposition_works
===========================
select
 data_id              --  '作品id自增'
,student_id      --  '学生id'
,uploader             --  '上传人用户id'
,teacher_id      	  --  '批阅的老师的id'
,pic_url              -- '作品图片路径'
,status               --  '状态'
,create_time          -- '创建时间'
,update_time          -- '更新时间'
,`comment`            -- '老师评语'
,features             -- '419返回的原始数据及匹配的特点id留根'
,topic                --  '绘画主题'
,source               --  '来源'
,feature_analysis     -- '特点解析'
,explanation          -- '原因解释'
,advising             -- '指导意见'
,reject_explanation   -- '驳回说明'
,confirmed            --  '是否已确认'
from  db_campus_platform.tb_disposition_works
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_measurement_result
===========================
select
 result_id             -- '编号'
,manage_info_id        -- '测评信息编号'
,scale_category_id     -- '量表分类Id'
,student_id       -- '学生Id'
,start_time            -- '开始时间'
,end_time              -- '结束时间'
,time_length           -- '测评所花的时间(单位：s)'
,score                 -- '测评结果分'
,t_score               -- '分'
,`result`              -- '测评结果'
,`level`               -- '结果等级'
,is_normal             -- '是否正常'
,status                -- '状态'
,create_time           --'创建时间'
,update_time           --'更新时间'
,recommend_name        --'推荐方案'
from  db_campus_platform.tb_measurement_result
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_measurement_manage_info
===========================
select
 manage_info_id      --  '编号'
,manage_info_name    --  '测评名称'
,start_time          --  '量表有效开始时间'
,end_time            --  '量表有效截止时间'
,sex                 --  '性别'
,scale_id            --  '量表编号'
,result_image_url    --  '测评结果图访问URL'
,image_url           --  '前端缩略图访问URL'
,status              --  '状态'
,create_time         --  '创建时间'
from  db_campus_platform.tb_measurement_manage_info
where str_to_date(create_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_report_disposition
===========================
select
 data_id           -- '主键自增'
,works_id          -- '心理分析作品id'
,pic_url           -- '作品图片'
,student_id   -- '学生标识'
,class_id     -- '班级标识'
,`date`            -- '统计日期'
,tags_normal       -- '正常标签'
,tags_negative     -- '负面标签'
,mode_type_1       -- '人格为外向性下的特性id'
,score_1           -- '外倾性得分'
,mode_type_5       -- '人格为开放性下的特性'
,score_5           -- '开放性得分'
,mode_type_9       -- '人格为宜人性下的特性'
,score_9           -- '宜人性得分'
,mode_type_13      -- '人格为责任心下的特性'
,score_13          -- '责任心得分'
,mode_type_17      -- '人格为情绪稳定性下的特性'
,score_17          -- '情绪稳定性得分'
,student_name      -- '学生姓名'
,photo_url         -- '学生头像'
from  db_campus_platform.tb_report_disposition;


===========================
tb_disposition_student_score
===========================
select
 data_id           -- '数据id,自增'
,student_id   -- '学生标识'
,mode_type_1       -- '外倾性得分'
,mode_type_5       -- '开放性得分'
,mode_type_9       -- '宜人性得分'
,mode_type_13      -- '责任心得分'
,mode_type_17      -- '情绪稳定性得分'
,create_time       -- '创建时间'
,update_time       -- '更新时间'
,last_id           -- '最后统计的一个心理作品id'
from  db_campus_platform.tb_disposition_student_score
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_interest_map_location
===========================
select
 map_location_id       -- '活动位置编号'
,map_id                -- '地图编号'
,org_id                -- '机构id'
,coordinates           -- '所在地图的位置坐标'
,location_name         -- '活动位置名称'
,`function`            -- '位置使用功能'
,status                -- '状态'
,create_time           -- '创建时间'
,update_time           -- '更新时间'
,`type`                -- '类型'
,class_room_id         -- '教室唯一标识'
,class_id              -- '班级唯一标识'
,number_people         -- '限定人数'
,areas_id              -- '公共区域ID'
from  db_campus_platform.tb_interest_map_location
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_interest_student_location
===========================
select
data_id            -- '主键标识',
,student_id   -- '学生唯一标识'
,map_location_id   -- '活动位置编号'
,time_length       -- '学生停留时长(单位秒)'
,enter_time        -- '进入时间'
,leave_time        -- '离开时间'
,create_time       -- '创建时间'
,update_time       -- '更新时间'
,activity_data     -- '活动数据表示:1(是) '
,source            -- '数据来源（1-米越，2-天波）'
from  db_campus_platform.tb_interest_student_location
where str_to_date(update_time,'%Y-%m-%d')  = date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_thermometer_data
===========================
select 
  thermometer_id           -- '体温Id'
  ,device_id 			   -- '设备编号'
  ,student_id 			   -- '学生唯一标识'
  ,`value`                 -- '体温值'
  ,`level`                 -- '（体温正常状态）0：偏低，1：正常   2：低热，3高热'
  ,measure_time            -- '测量时间（UTC）'
  ,upload_time             -- '上传时间(UTC)'
  ,source                  -- '数据来源：1-体温检测仪；2-家长APP；3-米越耳温枪'
  ,status                  -- '状态（0：无效 1：有效）'
  ,if_check               -- '状态（0：未审核 1：已审核）'
from db_campus_platform.tb_thermometer_data
where str_to_date(upload_time,'%Y-%m-%d') = date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_student_body_data
===========================
select
  body_data_id                   -- '唯一标识'
  ,student_id                    -- '学生唯一标识'
  ,device_no                     -- '设备编号'
  ,height                        -- '身高（cm）'
  ,weight                        -- '体重（kg）'
  ,`level`                       -- '（身材正常状态）  0：偏瘦  1：标准  2：超重  3：肥胖 99-其它'
  ,height_level                  -- '（身高状态）  0：偏矮  1：标准  2：偏高'
  ,measure_time         -- '测量时间（UTC）'
  ,upload_time          -- '上传时间(UTC)'
  ,source               -- '数据来源：1-身高体重仪；2-家长APP；3-NB-身高体重仪；4-后台导入,5:上和身高体重仪，6：鼎恒身高体重仪'
  ,status               -- '状态（0：无效 1：有效）'
  ,if_check             -- '状态（0：未审核 1：已审核）'
  ,bmi
from db_campus_platform.tb_student_body_data
where str_to_date(upload_time,'%Y-%m-%d') <str_to_date(now(),'%Y-%m-%d');


===========================
tb_class_room
===========================
select 
  class_room_id 		--	 '教室id'
  ,class_room_name 		--	 '教室名称（位置）'
  ,class_id 				--	 '班级id'
  ,status 				-- 	 '班级教室状态（0-失效 1-正常）'
  ,create_time 			--   '创建时间'
  ,update_time 			--   '更新时间'
  ,school_id 			--	 '学校id'
from db_campus_education.tb_class_room
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_sports_record
===========================
select 
  data_id 			-- '主键标识'
  ,device_no 		-- '设备编号'
  ,student_id 		-- '学生唯一标识'
  ,`value` 			-- '步数'
  ,`level` 			-- '保留'
  ,source 			-- '数据来源：1-手环；2-家长APP；3-手表'
  ,data_time 		-- '测量日期'
  ,measure_time 		-- '测量时间（utc）'
  ,upload_time 		-- '数据上传时间（utc）'
  ,step_type 		-- '步数类型：81-小时步数，111-总步数'
  ,from_type 		-- '来源类型：1-app,2-ap盒子'
from db_campus_platform.tb_sports_record
where str_to_date(upload_time,'%Y-%m-%d') = date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_file_allergy_relation
===========================
select
  data_id            -- '唯一标识'
  ,`file_id`          -- '学生健康档案id'
  ,allergy_id         -- '过敏源id'
  ,`status`           -- '0:失效，1：正常，2：停用'
  ,create_time        -- '创建时间'
  ,update_time        -- '更新时间'
from db_campus_platform.tb_file_allergy_relation
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_disposition_tag
===========================
select 
  tag_id             -- '标签id,自增'
  ,tag_name           -- '标签名'
  ,mood_type          -- '人格id'
  ,disposition_type   -- '特性id'
  ,is_negative        -- '是否负面 1-不是 2-是 (冗余字段)'
  ,score              -- '标签分值'
  ,status             -- '状态 0-无效 1-草稿 2-正式'
  ,create_time        -- '创建时间'
  ,update_time        -- '更新时间'
from db_campus_platform.tb_disposition_tag
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_holiday
===========================
select
  data_id             -- '主键id'
  ,org_id              -- '学校id(id为0,表示所有学校公用节假日信息)'
  ,holiday_year        -- '节假日年份'
  ,holiday_name        -- '节假日名称'
  ,holiday_type        -- '节日类型,0-国家法定节假日 1-特殊节假日'
  ,holiday_begin_date  -- '放假开始时间'
  ,holiday_end_date    -- '放假结束时间'
  ,deleted             -- '1-正常,0-删除'
  ,create_time         -- '创建时间'
  ,module_type         -- '所属模块(1-教职工、2-学生)'
  ,date_type           -- '日期类型(1-法定假日、2-新增假日、3-上课、4-休息，模块为学生时使用)'
from db_campus_platform.tb_holiday
where str_to_date(create_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_staff_archives
===========================
select 
  data_id            -- '自增主键'
  ,archives_id        -- '档案id(同用户id)'
  ,org_id             -- '机构id'
  ,avatar             -- '头像'
  ,staff_type         -- '人员类型(1-教师，2-教职工)'
  ,entry_date         -- '入职日期'
  ,status             -- '状态（0-停用 1-正常）'
  ,deleted            -- '删除 0-已删除 1-正常'
  ,position_id        -- '岗位id'
  ,dept_id            -- '部门id'
  ,create_time        -- '创建时间'
  ,change_type        -- '异动类型（1-在职,2-离职,3-辞退,4-外部调转,5-退休）'
  ,update_time        -- '修改时间'
  -- ,card_no            -- '卡号'
from db_campus_education.tb_staff_archives
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
clife_campus_ods_student_allergy_ingredients
===========================
select 
   record_id         -- '记录id'
  ,student_id        -- '学生唯一id'
  ,ingredient_id     -- '食材id'
  ,checkup_id        -- '幼儿健康-体检管理添加的过敏食材'
from db_campus_recipe.tb_student_allergy_ingredients;


===========================
clife_campus_ods_ingredients_info
===========================
select 
   ingredient_id          -- '编号'
  ,ingredient_name        -- '食材名称'
  ,total_category_id      -- '大分类ID'
  ,first_category_id      -- '一级分类ID'
  ,second_category_id     -- '二级分类ID'
  ,description            -- '营养描述'
  ,edible_part            -- '可食部（%）'
  ,water_content          -- '水分'
  ,energy                 -- '能量(Kcal)'
  ,protein                -- '蛋白质(g)'
  ,fat                    -- '脂肪(g)'
  ,carbohydrate           -- '碳水化合物(g)'
  ,insoluble_fiber        -- '不溶性纤维素(g)'
  ,total_vitaminA         -- '总维生素A(ugRAE)'
  ,vitaminB1              -- '维生素B1(mg)'
  ,vitaminB2              -- '维生素B2(mg)'
  ,nick_acid              -- '尼克酸(mg)'
  ,vitaminC               -- '维生素C(mg)'
  ,calcium                -- '钙(mg)'
  ,iron                   -- '铁(mg)'
  ,zinc                   -- '锌(mg)'
  ,status                 -- '状态：0-无效；1-有效'
  ,create_time            -- '创建时间'
  ,update_time            -- '修改时间'
  ,is_recommend           -- '是否推荐（1-是；2-否）'
  ,is_allergy             -- '1过敏食材0不是'
  ,ingredient_alias       -- '食材别名'
  ,url                    -- '食材图片url'
  ,is_common              -- '跟大数据食材库是否相交：1-相交;null-不相交'
from db_campus_recipe.tb_ingredients_info;


===========================
tb_interest_activity
===========================
select
 activity_id     --  '活动id'
,activity_name   --  '活动名称'
,start_time      --  '开始时间'
,end_time        --  '结束时间'
,org_id          --  '学校id'
,class_id        --  '班级Id'
,week            --  '日期'
,status          --  '状态'
,create_time     --  '创建时间'
,update_time     --  '更新时间'
from db_campus_platform.tb_interest_activity
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_water_drink_setting
===========================
select 
	data_id
	,org_id
	,grade_id
	,enough
	,standard
	,device_type
	,detail
	,create_time
	,update_time
	,deleted
from 
tb_water_drink_setting
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_sports_assess_setting
===========================
select 
	dataId
	,org_id
	,grade_id
	,adequate 
	,standard
	,insufficient 
	,create_time
	,update_time
from 
tb_sports_assess_setting
where str_to_date(update_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_student_am_inspection
===========================
select 
  inspection_id              -- '晨午检Id'
  ,org_id                    -- '学校Id'
  ,student_id                -- '学生Id'
  ,user_id                   -- '检查人Id'
  ,type                      -- '检查类型 0晨检 1午检'
  ,img                       -- '检查图片'
  ,is_temperature            -- '体温 0正常 1具体温度'
  ,temperature               -- '体温值(选择具体温度才有值)'
  ,inspection_date           -- '检查日期'
  ,is_abnormal               -- '检查结果 0异常 1正常'
  ,other_symptom             -- '其他症状'
  ,is_disease                -- '疾病确认(0可以确认 1无法确认)'
  ,disease_id                -- '疾病Id'
  ,infectious_disease        -- '是否传染病(0:否，1:是，2无法确认)'
  ,disease_name              -- '疾病名称'
  ,treatment                 -- '处理情况 0家长送医 1留园观察 2停课治疗 3其他'
  ,other                     -- '其他情况'
  ,deleted                   -- '是否删除 0是 1不是'
  ,status                    -- '状态 0已确定 1待确认'
  ,data_sources              -- '数据来源  0 web录入  1 智能设备 2批量创建 3移动端录入'
  ,create_time               -- '创建时间'
  ,update_time               -- '修改时间'
from db_campus_platform.tb_student_am_inspection;


===========================
tb_student_inspection_contagion
===========================
select
   inspection_id    -- '晨午检Id'
  ,contagion_id     -- '传染病Id'
  ,contagion_type   -- '传染病类型'
  ,create_time      -- '创建时间'
 from db_campus_platform.tb_student_inspection_contagion
where str_to_date(create_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_student_inspection_symptom
===========================
select
   inspection_id  -- '晨午检Id'
  ,symptom_id     -- '症状id'
  ,symptom_type   -- '症状类型'
  ,create_time    -- '创建时间'
 from db_campus_platform.tb_student_inspection_symptom
where str_to_date(create_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_into_campus_detail
===========================
select 
	record_id
	,org_id
	,student_id
	,data_time 
	,am_status 
	,am_time
	,`type` 
	,create_time
    ,value
    ,att_status
from 
tb_into_campus_detail
where str_to_date(create_time,'%Y-%m-%d')<str_to_date(now(),'%Y-%m-%d');


===========================
tb_sport_amount
===========================
select
  data_id         -- '记录ID'
  ,student_id      -- '学生唯一标识'
  ,device_no       -- '设备编号'
  ,measure_time    -- '测量时间'
  ,sport_num       -- '运动量'
  ,upload_time     -- '上传时间'
  ,source          -- '数据来源：1-手环；2-家长APP；3-手表'
from 
tb_sport_amount
where str_to_date(upload_time,'%Y-%m-%d')=date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_shit_card_data
===========================
select
 data_id	--   '主键标识'
,device_no	--   '设备编号'
,student_id	--   '学生唯一标识'
,value	    --   '数据index'
,card_time	--   '刷卡时间(本地)'
,status   	--   '1：有效）'
,upload_time	--   '上传时间(本地)'
from db_campus_platform.tb_shit_card_data
where str_to_date(upload_time,'%Y-%m-%d') <= date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_sport_amount_original
===========================
select
data_id	     --   '记录id'
,student_id	 --   '学生id'
,device_no	 --   '设备编号'
,measure_time	--   '测量时间'
,data_time	 --   '数据日期'
,sport_num	 --   '运动量'
,upload_time	--   '更新时间'
,source   	--   '1-手环；2-家长app；3-手表；4-米越；5-天波'
from db_campus_platform.tb_sport_amount_original
where str_to_date(upload_time,'%Y-%m-%d') = date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_student_info
===========================
select
student_id	--   '学生id'
,student_name	--   '姓名'
,org_id	--   '学校id'
,class_id	--   '班级id'
,class_name	--   '班级名称'
,grade_id	--   '年级id'
,grade_name	--   '年级名称'
,avatar	--   '头像'
,birthday	--   '出生日期'
,sex	--   '3-其他'
,enter_school_year	--   '学年'
,status	--   '3-结业）'
,deleted	--   '1-正常'
from db_campus_platform.tb_student_info


===========================
tb_system_dict_item
===========================
select
dict_id	--   '字典id'
,item_text	--   '字典项文本'
,item_value	--   '字典项值'
,description	--   '描述'
,show_order	--   '排序'
,deleted	--   '0：删除，1：正常'
,create_time	--   '创建时间'
,update_time
from db_campus_education.tb_system_dict_item


===========================
tb_user
===========================
select
 `user_id`	--   '用户id'
,username	--   '账号'
,real_name	--   '昵称'
,sex	--   '性别'
,mobile	--   '手机'
,email	--   '邮箱'
,id_card_type	--   '证件类型'
,id_card	--   '证件号码'
,birthday	--   '生日'
,nation	--   '民族'
,political_status	--   '政治面貌'
,education	--   '最高学历'
,province_id	--   '省份id'
,city_id	--   '城市id'
,area_id	--   '区县id'
,province_city_area	--   '省市区'
,address	--   '详细地址'
,clife_id	--   '公共平台的用户id'
,status	--   '1正常'
,deleted	--   '1正常0已删除'
,create_time	--   '创建时间'
,update_time	--   '更新时间'
from db_campus_education.tb_user
where DATE_FORMAT(update_time,'%Y-%m-%d') < DATE_FORMAT(now(),'%Y-%m-%d')


===========================
tb_message_type
===========================
select
data_id	--   'auto_increment'
,message_type	--   '消息类型对应应用的resource_id'
,message_type_name	--   '消息类型名称'
,user_type	--   '2-家长'
from db_campus_message.tb_message_type


===========================
tb_message
===========================
select
message_id	--   '信息编号'
,app_name	--   '应用名称'
,title	--   '标题'
,summary	--   '概要，简单描述'
,picture_url	--   '简图路径'
,sender	--   '发送者(系统发送的sender为0)'
,icon	--   '图标url'
,message_type	--   'resource_id'
,business_param	--   '业务参数的值json格式'
,status	--   '是否有效(0:无效；1正常)'
,create_time	--   '创建时间'
,jump_link_url	--   '跳转链接(应用代码)'
,content_type	--   '跳转消息)'
,data_flag	--   '数据来源标识（默认为0-普通推送消息；1-园丁端老师；2-校园运营端）'
from db_campus_message.tb_message
where DATE_FORMAT(create_time,'%Y-%m-%d') < DATE_FORMAT(now(),'%Y-%m-%d')


===========================
tb_message_user
===========================
select
 data_id	--   '自增主键'
,user_id	--   '用户id'
,message_id	--   '消息id'
,org_id	--   '机构id'
,student_id	--   '学生id'
,user_type	--   '2-家长'
,status	--   '消息状态（0-删除，1-未读，2-已读）'
,create_time	--   '创建时间'
,update_time	--   '更新时间'
from db_campus_message.tb_message_user
where DATE_FORMAT(create_time,'%Y-%m-%d') < DATE_FORMAT(now(),'%Y-%m-%d')


===========================
tb_user_class
===========================
select
 org_id  
,user_id 
,class_id
from db_campus_education.tb_user_class


===========================
tb_medicine_details
===========================
select 
    data_id                        , -- 唯一标识
    feeding_id                     , -- 喂药信息id
    medicine_name                  , -- 药物名称
    medication_time                , -- 用药时间
    medication_method              , -- 用药方式，0：口服，1：外用
    dosage                         , -- 用药剂量
    unit                           , -- 单位，0：包，1：颗，2：滴，3：ml
    picture_url                    , -- 药物图片url
    medication_status              , -- 0：待喂药，1：已喂药
    status                         , -- 0：失效，1：正常，2：停用
    update_time                    , -- 更新时间
    create_time                    , -- 创建时间
    moment                           -- 0：早上，1：中午
from db_campus_platform.tb_medicine_details
where str_to_date(update_time,'%Y-%m-%d') <= date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_medicine
===========================
select 
    data_id                        , -- 唯一标识
    student_id                     , -- 学生id
    medication_date                , -- 喂药日期
    whether_inspect                , -- 药品是否视检,0:否，1：是
    medication_reasons             , -- 用药原因
    number_of_feeding              , -- 喂药次数
    deleted                        , -- 0：删除，1：正常
    status                         , -- 1-待视检、2-已撤销、3-已视检、4-已完成
    source                         , -- 0-老师录入，1-家长录入
    update_time                    , -- 更新时间
    create_time                    , -- 创建时间
    parent_sign_url                  -- 家长签字图片                               
from db_campus_platform.tb_medicine
where str_to_date(update_time,'%Y-%m-%d') <= date_add(str_to_date(now(),'%Y-%m-%d'), interval -1 day);


===========================
tb_position
===========================
select
 position_id	
,org_id	
,position_name	
,deleted	    
,create_time	
,update_time	
from db_campus_education.tb_position
where DATE_FORMAT(if(update_time is null,create_time,update_time),'%Y-%m-%d') < DATE_FORMAT(now(),'%Y-%m-%d')


===========================
clife_campus_dwd_health_stu
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_health_stu partition(part_date)
select
  t.student_id                 -- '学生id'
  ,t.student_name               -- '姓名'
  ,t.sex                        -- '1-男 2-女 3-其他'
  ,t.age                        --  '年龄'
  ,t.class_id                   -- '班级id'
  ,t.class_name                 -- '班级名称'
  ,t.grade_id                   -- '年级id'
  ,t.grade_name                 -- '年级名称'
  ,t.org_id                     -- '学校id'
  ,t.org_name                   -- '学校名称'
  ,t.area_id 				     -- '区县id'
  ,a.serious_disease_history 	     -- '各种严重病史'
  ,a.serious_disease_history_details      -- '严重病史详情'
  ,a.infectious_disease_history     -- '各种传染病史'
  ,a.infectious_disease_history_details   -- '传染病史详情'
  ,c.weight                     -- '体重（单位：kg）'
  ,c.`level`              -- '0：中上，1：中等，2：中下'
  ,c.height                     -- '身高（单位：cm）'
  ,c.height_level              -- '0：中上，1：中等，2：中下'
  ,c.bmi                        -- 'bmi数值'
  ,case when c.bmi<e.value1 then 0 
        when c.bmi>=e.value1 and c.bmi<e.value3 then 1
		when c.bmi>=e.value3 and c.bmi<e.value4 then 2
		when c.bmi>=e.value4 then 3
		else null end as bmi_assess                 -- '身材正常状态）  0：偏瘦  1：标准  2：超重  3：肥胖 99-其它'
  ,a.left_eye                   -- '左眼健康'
  ,a.right_eye                  -- '右眼健康'
  ,b.left_vision                -- '左视力'
  ,b.right_vision               -- '右视力'
  ,case when b.left_abnormal =0 then 2 else b.left_abnormal	end	left_abnormal		     -- '左视力健康'
  ,case when b.right_abnormal =0 then 2 else b.right_abnormal end right_abnormal		 -- '右视力健康'
  ,a.number_of_caries           -- '龋齿数'
  ,a.number_of_teeth            -- '牙齿数量'
  ,a.head_neck 				 -- ' 头颈'
  ,a.thoracic 					 -- '胸廓'
  ,a.spine 					 -- '脊椎'
  ,a.limbs 					 -- '四肢'
  ,a.pharynx 					 -- '咽部'
  ,a.heart 					 -- '心'
  ,a.lung 						 -- '肺'
  ,a.liver 					 -- '肝'
  ,a.spleen 					 -- '脾'
  ,a.hemoglobin 				 -- '血红蛋白（单位：g/h）'
  ,a.alt 						 -- '丙氨酸氨基转移酶'
  ,a.lack 						 -- '接种情况'
  ,a.whether_allergy 			 --'是否过敏体质，0：否，1：是'
  ,d.allergy_ingredients        -- '过敏食材'
  ,t.part_date
from 
dwh_dw_campus.clife_campus_dim_student t 
left join 
(select t2.* from (
select 
  t1.*,
  row_number() over(partition by student_data_id order by update_time desc) as ranks
  from
  dwh_ods_campus_new.clife_campus_ods_stu_health t1
where part_date=regexp_replace(date_sub(current_date(),1),'-','') and status=1 and deleted=1
) t2 where t2.ranks=1)
 a  
on t.student_id=a.student_data_id
left join 
( 
select t2.* from 
(select 
t1.*
,row_number() over(partition by student_id order by upload_time desc) as ranks
 from dwh_ods_campus_new.clife_campus_ods_vision_data t1
 where part_date=regexp_replace(date_sub(current_date(),1),'-','')) t2 where t2.ranks=1
) b 
on t.student_id=b.student_id
left join 
(
select t2.* from (
select 
t1.*
,row_number() over(partition by student_id order by upload_time desc) as ranks
 from dwh_ods_campus_new.clife_campus_ods_student_body_data t1
 where part_date=regexp_replace(date_sub(current_date(),1),'-','') and status=1) t2 where t2.ranks=1 
) c 
on t.student_id=c.student_id
left join 
(
select 
b1.student_id,
concat_ws(',',collect_set(cast(b1.ingredient_id as string))) as allergy_ingredients 
from dwh_ods_campus_new.clife_campus_ods_student_allergy_ingredients b1 
where b1.part_date=regexp_replace(date_sub(current_date(),1),'-','') 
group by b1.student_id 
) d 
on t.student_id=d.student_id
left join 
dwh_ods_campus_new.clife_campus_ods_public_standard_bmi e
on t.sex=e.bmi_sex and t.age=e.bmi_age and  t.`month`=e.`month` and e.bmi_type=1
where t.part_date=regexp_replace(date_sub(current_date(),1),'-','') and t.status=1 and t.deleted=1


===========================
clife_campus_dwd_robot_check_report
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_robot_check_report partition(part_date)
select 
 a.data_id          -- '主键标识'
,a.student_id  	  -- '学生唯一标识'
,b.student_name     -- '学生姓名'
,b.sex              -- '性别'
,b.age              -- '年龄'
,b.class_id         -- '班级id'
,b.class_name       -- '班级名称' 
,b.grade_id         -- '年级id'
,b.grade_name       -- '年级名称'
,b.org_id           -- '学校id'
,b.org_name         -- '学校名称'
,b.area_id          -- '学校区县id'
,a.measure_time     -- '晨检时间'
,a.device_id        -- '设备ID'
,a.mac_address      -- 'MAC地址'
,a.product_id       -- '产品标识'
,a.card_no          -- '卡号'
,a.temperature      -- '体温'
,a.level            -- '体温状态'
,a.hand             -- '手部异常'
,a.mouth            -- '口腔异常'
,a.red_eye          -- '红眼'
,a.fever            -- '发烧'
,a.cheek            -- '腮部肿大'
,a.spirit           -- '精神不佳'
,a.throat           -- '咽炎'
,a.trauma           -- '外伤'
,a.cough            -- '咳嗽'
,a.fingernail       -- '指甲过长'
,a.tooth_decay      -- '蛀牙'
,a.other            -- '其他异常'
,a.hand_img         -- '手部异常图像'
,a.mouth_img        -- '口腔异常图像'
,a.eye_img          -- '眼睛异常图像'
,a.data_type        -- '数据类型'
,a.abnormal_num     -- '异常数量'
,a.upload_time      -- '上传时间'
,case when a.access = 'Y' then 1 
      when a.access = 'N' then 0 
      else null end as access	  -- '是否允许入园(1-是、0-否)'
,a.part_date
from 
 dwh_dw_campus.clife_campus_dim_student b
 left join 
 dwh_ods_campus_new.clife_campus_ods_robot_check_report a 
 on a.student_id=b.student_id and a.part_date=regexp_replace(date_sub(current_date(),1),'-','')  and substr(a.measure_time,0,10)=date_sub(current_date(),1)
where  b.part_date=regexp_replace(date_sub(current_date(),1),'-','') and b.status=1 and b.deleted=1


===========================
clife_campus_dwd_water_drink_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_water_drink_info partition(part_date)
select 
	 a.data_id          -- '主键标识'
	,a.student_id  	  -- '学生唯一标识'
	,b.student_name     -- '学生姓名'
	,b.sex              -- '性别'
	,b.age              -- '年龄'
	,b.class_id         -- '班级id'
	,b.class_name       -- '班级名称' 
	,b.grade_id         -- '年级id'
	,b.grade_name       -- '年级名称'
	,b.org_id           -- '学校id'
	,b.org_name         -- '学校名称'
	,b.area_id          -- '学校区县id'
	,a.device_no        -- '设备编号'
   ,a.cdate            -- '刷卡时间'
   ,a.card_no          -- '卡号'
   ,a.water_amount     -- '出水量'
   ,a.is_auto          -- '是否自动'
   ,a.intds            -- '进水TDS'
   ,a.outtds           -- '出水TDS'
   ,a.temperature      -- '饮水温度'
   ,a.time_integer     -- '时分秒整数'
   ,a.device_type      -- '净饮机类型'
   ,a.create_time      -- '创建时间'
   ,a.device_position  -- '饮水机位置'
	,a.part_date
from 
 dwh_ods_campus_new.clife_campus_ods_water_drink_record a
 left join 
 dwh_dw_campus.clife_campus_dim_student b 
 on a.student_id=b.student_id and b.part_date=regexp_replace(date_sub(current_date(),1),'-','')
 where a.part_date=regexp_replace(date_sub(current_date(),1),'-','') and substr(a.create_time,1,10)=date_sub(current_date(),1)


===========================
clife_campus_dwd_thermometer_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_thermometer_info partition(part_date)
select 
	 a.thermometer_id   -- '主键标识'
	,a.student_id  	  -- '学生唯一标识'
	,b.student_name     -- '学生姓名'
	,b.sex              -- '性别'
	,b.age              -- '年龄'
	,b.class_id         -- '班级id'
	,b.class_name       -- '班级名称' 
	,b.grade_id         -- '年级id'
	,b.grade_name       -- '年级名称'
	,b.org_id           -- '学校id'
	,b.org_name         -- '学校名称'
	,b.area_id          -- '学校区县id'
    ,a.device_id        -- '设备编号'
    ,a.value            -- '体温值'
	,a.level            -- '体温正常状态'
	,a.measure_time -- '测量时间'
	,a.upload_time -- '上传时间'
	,a.source           -- '数据来源'
	,a.status           -- '是否有效'
	,a.if_check         -- '是否审核'
	,a.part_date
from 
 dwh_ods_campus_new.clife_campus_ods_thermometer_data a
 left join 
 dwh_dw_campus.clife_campus_dim_student b 
 on a.student_id=b.student_id and b.deleted = 1 and b.status = 1 and b.part_date=regexp_replace(date_sub(current_date(),1),'-','')
where a.part_date=regexp_replace(date_sub(current_date(),1),'-','') and substr(a.upload_time,0,10)=date_sub(current_date(),1)



===========================
clife_campus_dwd_student_attendance_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_student_attendance_info partition(part_date)
select  
    b.student_id, --'学生唯一id'
    b.student_name, --'学生姓名'
    b.sex,         --'性别'
    b.age,          --'年龄'
  	b.class_id,     --'班级id'     
  	b.class_name,   --'班级名称'
  	b.grade_id,     --'年级id'
  	b.grade_name,   --'年级名称'
  	b.org_id,       --'学校id'
 	b.org_name,     --'学校名称'
  	b.area_id,      --'学校区县id'
  	substr(a.data_time,1,10),
  	a.am_card_time, --'入园时间'
  	a.pm_card_time, --'离园时间'
  	a.`result`,     --状态
 	a.content,      --'内容'
    a.update_time,  --'更新时间'
    a.update_by_user, --'更新人'
    a.card_url,      --'打卡图片'
    a.am_url,        --'打卡图片-入园'
    a.pm_url,        --'打卡图片-离园'
    regexp_replace(date_sub(current_date(),1),'-','') as part_date
from 
 dwh_ods_campus_new.clife_campus_ods_student_attendance_daily a
 left join 
 dwh_dw_campus.clife_campus_dim_student b 
 on a.student_id=b.student_id and b.part_date=regexp_replace(date_sub(current_date(),1),'-','') and b.status=1 and b.deleted=1
where a.part_date=regexp_replace(date_sub(current_date(),1),'-','') and substr(a.update_time,1,10)=date_sub(current_date(),1)



===========================
clife_campus_dwd_sleep_day_data
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_sleep_day_data partition(part_date)
select 
  a.student_id                 -- '学生id'
  ,a.student_name               -- '姓名'
  ,a.sex                        -- '1-男 2-女 3-其他'
  ,a.age                        --  '年龄'
  ,a.class_id                   -- '班级id'
  ,a.class_name                 -- '班级名称'
  ,a.grade_id                   -- '年级id'
  ,a.grade_name                 -- '年级名称'
  ,a.org_id                     -- '学校id'
  ,a.org_name                   -- '学校名称'
  ,a.area_id 				     -- '区县id'
  ,b.device_no                  -- '设备编号'
  ,b.sleep_duration             -- '睡眠时长（秒）'
  ,b.wake_duration              -- '清醒时长（秒）'
  ,b.wake_number                -- '清醒次数'
  ,b.score                      -- '睡眠打分'
  ,c.start_time                -- '睡眠状态开始时间'
  ,c.end_time                   -- '睡眠状态结束时间'
  ,b.upload_time                -- '上传时间'
  ,b.create_time                -- '创建时间'
  ,b.source                     -- '数据来源(1-天波手环，3-睡眠带子)'
  ,a.part_date
from 
dwh_dw_campus.clife_campus_dim_student a 
left join 
dwh_ods_campus_new.clife_campus_ods_sleep_day_data b 
on a.student_id=b.student_id and b.part_date=regexp_replace(date_sub(current_date(),1),'-','') and substr(b.upload_time,0,10)=date_sub(current_date(),1)
left join 
(
select 
student_id,substr(start_time,0,10) as `date`,
min(start_time) start_time,
max(end_time) end_time
from (
select *,
case when status=7 then start_time else null end as end_time
from dwh_ods_campus_new.clife_campus_ods_sleep_day_status 
where part_date=regexp_replace(date_sub(current_date(),1),'-','') and substr(start_time,0,10)=date_sub(current_date(),1)
) t1  
group by t1.student_id,substr(start_time,0,10)
) c 
on a.student_id=c.student_id  and substr(b.upload_time,0,10)=c.`date`
where a.part_date=regexp_replace(date_sub(current_date(),1),'-','') and a.status=1 and a.deleted=1


===========================
clife_campus_dwd_sports_record
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_sports_record partition(part_date)
select 
   a.data_id                    -- '主键标识'
  ,a.student_id                 -- '学生唯一标识'
  ,b.student_name               -- '姓名'
  ,b.sex                        -- '1-男 2-女 3-其他'
  ,b.age                        --  '年龄'
  ,b.class_id                   -- '班级id'
  ,b.class_name                 -- '班级名称'
  ,b.grade_id                   -- '年级id'
  ,b.grade_name                 -- '年级名称'
  ,b.org_id                     -- '学校id'
  ,b.org_name                   -- '学校名称'
  ,b.area_id                      -- '区县id'
  ,a.device_no                  -- '设备编号'
  ,a.`value`                    -- '步数'
  ,a.`level`                    -- '保留'
  ,a.source                     -- '数据来源：1-手环；2-家长APP；3-手表'
  ,a.measure_time               -- '测量时间'
  ,a.upload_time               -- '数据上传时间'
  ,a.step_type                  -- '步数类型：81-小时步数，111-总步数'
  ,a.from_type                  -- '来源类型：1-app,2-ap盒子'
  ,regexp_replace(substr(a.measure_time,0,10),'-','')   as part_date               -- '测量时间'
from (
select 
 * 
from dwh_ods_campus_new.clife_campus_ods_sports_record where part_date = regexp_replace(date_sub(current_date(),1),'-','') 
         and substr(measure_time,0,10) > date_sub(current_date(),10)
) a 
left join (
select 
 * 
from dwh_dw_campus.clife_campus_dim_student where part_date > regexp_replace(date_sub(current_date(),10),'-','')
) b 
on a.student_id=b.student_id and regexp_replace(substr(a.measure_time,0,10),'-','')=b.part_date and b.status=1 and b.deleted=1


===========================
clife_campus_dwd_disposition_stu_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_disposition_stu_info partition(part_date)
select
     t.student_id             -- '学生id'
    ,t.student_name           -- '姓名'
    ,t.sex                    -- '性别'
    ,t.age                    -- '年龄'
    ,t.class_id               -- '班级id'
    ,t.class_name             -- '班级名称'
    ,t.grade_id               -- '年级id'
    ,t.grade_name             -- '年级名称'
    ,t.org_id                 -- '学校id'
    ,t.org_name               -- '学校名称'
    ,t3.area_id    as org_area_id   -- '学校县区id'
    ,t4.area_name  as org_area_name -- '学校县区名称'
    ,mens_score_1                    --外向性测评结果分	
    ,mens_t_score_1                --外向性测评结果t分	
    ,mens_level_1                    --外向性测评结果	
    ,mens_result_1                  --外向性结果等级	
    ,mens_is_normal_1            --外向性是否正常	
    ,mens_recommend_name_1  --外向性推荐方案	
    ,manage_info_name_1   --外向性测评名称	
    ,start_time_1               --外向性有效开始测评时间	
    ,end_time_1                   --外向性有效截止时间	
    ,mens_score_5                    --开放性测评结果分	
    ,mens_t_score_5                --开放性测评结果t分	
    ,mens_result_5                  --开放性测评结果	
    ,mens_level_5                    --开放性结果等级	
    ,mens_is_normal_5            --开放性是否正常	
    ,mens_recommend_name_5  --开放性推荐方案	
    ,manage_info_name_5   --开放性测评名称	
    ,start_time_5               --开放性有效开始测评时间	
    ,end_time_5                   --开放性有效截止时间	
    ,mens_score_9                    --宜人性测评结果分	
    ,mens_t_score_9                --宜人性测评结果t分	
    ,mens_result_9                  --宜人性测评结果	
    ,mens_level_9                    --宜人性结果等级	
    ,mens_is_normal_9            --宜人性是否正常	
    ,mens_recommend_name_9  --宜人性推荐方案	
    ,manage_info_name_9   --宜人性测评名称	
    ,start_time_9               --宜人性有效开始测评时间	
    ,end_time_9                   --宜人性有效截止时间	
    ,mens_score_13                       --责任心测评结果分	
    ,mens_t_score_13                   --责任心测评结果t分	
    ,mens_result_13                     --责任心测评结果	
    ,mens_level_13                       --责任心结果等级	
    ,mens_is_normal_13               --责任心是否正常	
    ,mens_recommend_name_13     --责任心推荐方案	
    ,manage_info_name_13      --责任心测评名称	
    ,start_time_13                  --责任心有效开始测评时间	
    ,end_time_13                      --责任心有效截止时间		
    ,mens_score_17                   --情绪稳定性测评结果分	
    ,mens_t_score_17               --情绪稳定性测评结果t分	
    ,mens_result_17                 --情绪稳定性测评结果	
    ,mens_level_17                   --情绪稳定性结果等级	
    ,mens_is_normal_17           --情绪稳定性是否正常	
    ,mens_recommend_name_17 --情绪稳定性推荐方案	
    ,manage_info_name_17  --情绪稳定性测评名称	
    ,start_time_17              --情绪稳定性有效开始测评时间	
    ,end_time_17                  --情绪稳定性有效截止时间	
    ,mode_type_1	          --人格为外向性下的特性id
    ,mode_type_score_1	  --外倾性得分
    ,mode_type_5	          --人格为开放性下的特性id
    ,mode_type_score_5     --开放性得分
    ,mode_type_9	          --人格为宜人性下的特性id
    ,mode_type_score_9     --宜人性得分
    ,mode_type_13	      --人格为责任心下的特性id
    ,mode_type_score_13    --责任心得分
    ,mode_type_17	      --人格为情绪稳定性下的特性id
    ,mode_type_score_17    --情绪稳定性得分
    ,tags_normal          --正常标签
    ,tags_negative        --负面标签	
    ,cast((case when mens_t_score_1 is null then null
                     when mode_type_score_1 is null then mens_t_score_1
                else (mens_t_score_1*0.6)+(mode_type_score_1*0.4)  end) as int ) as synthesis_score_1  --综合外倾性人格得分
    ,cast((case when mens_t_score_5 is null then null
                     when mode_type_score_5 is null then mens_t_score_5
                else (mens_t_score_5*0.6)+(mode_type_score_5*0.4)  end) as int ) as synthesis_score_5  --综合开放性人格得分
    ,cast((case when mens_t_score_9 is null then null
                     when mode_type_score_9 is null then mens_t_score_9
                else (mens_t_score_9*0.6)+(mode_type_score_9*0.4)  end) as int ) as synthesis_score_9  --综合宜人性人格得分
    ,cast((case when mens_t_score_13 is null then null
                     when mode_type_score_13 is null then mens_t_score_13
                else (mens_t_score_13*0.6)+(mode_type_score_13*0.4)  end) as int ) as synthesis_score_13  --综合责任心人格得分
    ,cast((case when mens_t_score_17 is null then null
                     when mode_type_score_17 is null then mens_t_score_17
                else (mens_t_score_17*0.6)+(mode_type_score_17*0.4)  end) as int ) as synthesis_score_17  --综合情绪稳定性人格得分
    ,regexp_replace(date_sub(current_date(),1),'-','')
from 
(
  select * from dwh_dw_campus.clife_campus_dim_student
  where part_date = regexp_replace(date_sub(current_date(),1),'-','') 
)t
left join
(
  select
       student_id
      ,max(case when b.name = '155' then a.score else null end)            as mens_score_1                    --外向性测评结果分
  	  ,max(case when b.name = '155' then a.t_score else null end)          as mens_t_score_1                --外向性测评结果t分
  	  ,max(case when b.name = '155' then a.level else null end)            as mens_level_1                    --外向性测评结果
  	  ,max(case when b.name = '155' then a.result else null end)           as mens_result_1                  --外向性结果等级
  	  ,max(case when b.name = '155' then a.is_normal else null end)        as mens_is_normal_1            --外向性是否正常
  	  ,max(case when b.name = '155' then a.recommend_name else null end)   as mens_recommend_name_1  --外向性推荐方案
  	  ,max(case when b.name = '155' then c.manage_info_name else null end) as manage_info_name_1   --外向性测评名称
  	  ,max(case when b.name = '155' then c.start_time else null end)       as start_time_1               --外向性有效开始测评时间
  	  ,max(case when b.name = '155' then c.end_time else null end)         as end_time_1                   --外向性有效截止时间
  	  ,max(case when b.name = '156' then a.score else null end)            as mens_score_5                    --开放性测评结果分
  	  ,max(case when b.name = '156' then a.t_score else null end)          as mens_t_score_5                --开放性测评结果t分
  	  ,max(case when b.name = '156' then a.result else null end)           as mens_result_5                  --开放性测评结果
  	  ,max(case when b.name = '156' then a.level else null end)            as mens_level_5                    --开放性结果等级
  	  ,max(case when b.name = '156' then a.is_normal else null end)        as mens_is_normal_5            --开放性是否正常
  	  ,max(case when b.name = '156' then a.recommend_name else null end)   as mens_recommend_name_5  --开放性推荐方案
      ,max(case when b.name = '156' then c.manage_info_name else null end) as manage_info_name_5   --开放性测评名称
      ,max(case when b.name = '156' then c.start_time else null end)       as start_time_5               --开放性有效开始测评时间
  	  ,max(case when b.name = '156' then c.end_time else null end)         as end_time_5                   --开放性有效截止时间
  	  ,max(case when b.name = '157' then a.score else null end)            as mens_score_9                    --宜人性测评结果分
  	  ,max(case when b.name = '157' then a.t_score else null end)          as mens_t_score_9                --宜人性测评结果t分
  	  ,max(case when b.name = '157' then a.result else null end)           as mens_result_9                  --宜人性测评结果
  	  ,max(case when b.name = '157' then a.level else null end)            as mens_level_9                    --宜人性结果等级
  	  ,max(case when b.name = '157' then a.is_normal else null end)        as mens_is_normal_9            --宜人性是否正常
  	  ,max(case when b.name = '157' then a.recommend_name else null end)   as mens_recommend_name_9  --宜人性推荐方案
      ,max(case when b.name = '157' then c.manage_info_name else null end) as manage_info_name_9   --宜人性测评名称
  	  ,max(case when b.name = '157' then c.start_time else null end)       as start_time_9               --宜人性有效开始测评时间
  	  ,max(case when b.name = '157' then c.end_time else null end)         as end_time_9                   --宜人性有效截止时间
  	  ,max(case when b.name = '158' then a.score else null end)            as mens_score_13                       --责任心测评结果分
  	  ,max(case when b.name = '158' then a.t_score else null end)          as mens_t_score_13                   --责任心测评结果t分
  	  ,max(case when b.name = '158' then a.result else null end)           as mens_result_13                     --责任心测评结果
  	  ,max(case when b.name = '158' then a.level else null end)            as mens_level_13                       --责任心结果等级
  	  ,max(case when b.name = '158' then a.is_normal else null end)        as mens_is_normal_13               --责任心是否正常
  	  ,max(case when b.name = '158' then a.recommend_name else null end)   as mens_recommend_name_13     --责任心推荐方案
      ,max(case when b.name = '158' then c.manage_info_name else null end) as manage_info_name_13      --责任心测评名称
      ,max(case when b.name = '158' then c.start_time else null end)       as start_time_13                  --责任心有效开始测评时间
      ,max(case when b.name = '158' then c.end_time else null end)         as end_time_13                      --责任心有效截止时间	
      ,max(case when b.name = '159' then a.score else null end)        as mens_score_17                   --情绪稳定性测评结果分
      ,max(case when b.name = '159' then a.t_score else null end)      as mens_t_score_17               --情绪稳定性测评结果t分
      ,max(case when b.name = '159' then a.result else null end)       as mens_result_17                 --情绪稳定性测评结果
      ,max(case when b.name = '159' then a.level else null end)        as mens_level_17                   --情绪稳定性结果等级
      ,max(case when b.name = '159' then a.is_normal else null end)    as mens_is_normal_17           --情绪稳定性是否正常
      ,max(case when b.name = '159' then a.recommend_name else null end)   as mens_recommend_name_17 --情绪稳定性推荐方案
      ,max(case when b.name = '159' then c.manage_info_name else null end) as manage_info_name_17  --情绪稳定性测评名称
      ,max(case when b.name = '159' then c.start_time else null end)       as start_time_17              --情绪稳定性有效开始测评时间
      ,max(case when b.name = '159' then c.end_time else null end)         as end_time_17                  --情绪稳定性有效截止时间
  from
  (
     select
          tb.*
     from
     (
        select
             tr.*
            ,row_number() over(partition by  student_id,manage_info_id order by end_time desc) as ranks
        from dwh_ods_campus_new.clife_campus_ods_measurement_result tr
        where part_date = regexp_replace(date_sub(current_date(),1),'-','')
          and `status` = 1 and end_time is not null
     )tb
     where tb.ranks = 1
  )a
  left join
  (
    select * from dwh_ods_campus_new.clife_campus_ods_config
    where part_date = regexp_replace(date_sub(current_date(),1),'-','')
      and group_id = 10030 
  )b on a.manage_info_id = b.name
  left join
  (
    select * from dwh_ods_campus_new.clife_campus_ods_measurement_manage_info
    where part_date = regexp_replace(date_sub(current_date(),1),'-','')
  )c on a.manage_info_id = c.manage_info_id
  where b.group_id = 10030
  group by student_id
)t1 on t.student_id = t1.student_id
left join
(
   select
        student_id
       ,mode_type_1
       ,mode_type_score_1
       ,mode_type_5
       ,mode_type_score_5
       ,mode_type_9
       ,mode_type_score_9
       ,mode_type_13
       ,mode_type_score_13
       ,mode_type_17
       ,mode_type_score_17
       ,concat_ws(',',collect_set(pv.notagName))  as tags_normal      --正常标签
       ,concat_ws(',',collect_set(pe.netagName))  as tags_negative    --负面标签
   from
   (
      select 
           student_id
          ,mode_type_1         --人格为外向性下的特性id
          ,case when s1 is not null then ROUND(s1/c1) else null end mode_type_score_1      --外倾性得分
          ,mode_type_5         --人格为开放性下的特性
          ,case when s5 is not null then ROUND(s5/c5) else null end mode_type_score_5      --开放性得分
          ,mode_type_9         --人格为宜人性下的特性
          ,case when s9 is not null then ROUND(s9/c9) else null end mode_type_score_9      --宜人性得分
          ,mode_type_13        --人格为责任心下的特性
          ,case when s13 is not null then ROUND(s13/c13) else null end mode_type_score_13  --责任心得分
          ,mode_type_17        --人格为情绪稳定性下的特性
          ,case when s17 is not null then ROUND(s17/c17) else null end mode_type_score_17  --情绪稳定性得分
          ,h.tags_normal
          ,k.tags_negative
      from 
      (
         select 
              student_id               --学生id
             ,sum(score_1)   as s1     --外倾性得分
             ,count(score_1) as c1     --外倾性个数
             ,sum(score_5)   as s5     --开放性得分
             ,count(score_5) as c5     --开放性个数 
             ,sum(score_9)   as s9     --宜人性得分
             ,count(score_9) as c9     --宜人性个数
             ,sum(score_13)    as s13  --责任心得分
             ,count(score_13)  as c13  --责任心个数
             ,sum(score_17)    as s17  --情绪稳定性得分
             ,count(score_17)  as c17  --情绪稳定性个数
             ,max(mode_type_1)    as mode_type_1     --人格为外向性下的特性id
             ,max(mode_type_5)    as mode_type_5     --人格为开放性下的特性
             ,max(mode_type_9)    as mode_type_9     --人格为宜人性下的特性
             ,max(mode_type_13)   as mode_type_13     --人格为责任心下的特性
             ,max(mode_type_17)   as mode_type_17     --人格为情绪稳定性下的特性
             ,max(split(regexp_replace(regexp_extract(tags_normal,'^\\[(.+)\\]$',1),'\\}\\,\\{', '\\}\\|\\|\\{'),'\\|\\|'))    as tags_normal  --正常标签
             ,max(split(regexp_replace(regexp_extract(tags_negative,'^\\[(.+)\\]$',1),'\\}\\,\\{', '\\}\\|\\|\\{'),'\\|\\|'))  as tags_negative    --负面标签
         from 
         (
           select * from dwh_ods_campus_new.clife_campus_ods_report_disposition
           where part_date = regexp_replace(date_sub(current_date(),1),'-','')
         )p        
         group by student_id
      )t lateral view outer explode(t.tags_normal) h as tags_normal
         lateral view outer explode(t.tags_negative) k as tags_negative
   )m lateral view json_tuple(m.tags_normal,'tagName')pv as notagName
      lateral view json_tuple(m.tags_negative,'tagName')pe as netagName
   group by student_id
           ,mode_type_1
           ,mode_type_score_1
           ,mode_type_5
           ,mode_type_score_5
           ,mode_type_9
           ,mode_type_score_9
           ,mode_type_13
           ,mode_type_score_13
           ,mode_type_17
           ,mode_type_score_17
)t2 on t.student_id = t2.student_id
left join
(
   select * from dwh_dw_campus.clife_campus_dim_org
   where part_date = regexp_replace(date_sub(current_date(),1),'-','')
)t3 on t.org_id = t3.org_id
left join
(
   select * from dwh_dw_campus.clife_campus_dim_area
)t4 on t3.area_id = t4.area_id
where t.part_date = regexp_replace(date_sub(current_date(),1),'-','')


===========================
clife_campus_dwd_location_stu
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_location_stu partition(part_date)
select
     a.data_id           
    ,a.map_location_id        --'活动位置编号'
    ,b.location_name          --'活动位置名称'
    ,b.`type`                 --'类型'
    ,a.time_length            --'学生停留时长(单位秒)'
    ,a.enter_time             --'进入时间'
    ,a.leave_time             --'离开时间'
    ,a.activity_data          --'活动数据表示:1(是) '
    ,a.source                 --'数据来源（1-米越，2-天波）'
    ,a.student_id             --'学生唯一标识'
    ,c.student_name           -- '姓名'
    ,c.sex                    -- '1-男 2-女 3-其他'
    ,c.age                    -- '年龄'
    ,c.org_id                 -- '学校id'
    ,c.org_name               -- '学校名称'
    ,c.grade_id               -- '年级id'
    ,c.grade_name             -- '年级名称'
    ,c.class_id               -- '班级id'
    ,c.class_name             -- '班级名称'
    ,d.area_id    as org_area_id            -- '学校县区id'
    ,e.area_name  as org_area_name          -- '学校县区名称'
    ,regexp_replace(date_sub(current_date(),1),'-','') as part_date
from
(
    select
         data_id               --'主键标识'
        ,student_id           --'学生唯一标识'
        ,map_location_id      --'活动位置编号'
        ,time_length          --'学生停留时长(单位秒)'
        ,enter_time   --'进入时间'
        ,leave_time   --'离开时间'
        ,activity_data        --'活动数据表示:1(是) '
        ,source               --'数据来源（1-米越，2-天波）'
    from dwh_ods_campus_new.clife_campus_ods_student_location
    where part_date = regexp_replace(date_sub(current_date(),1),'-','') and substr(update_time,0,10)=date_sub(current_date(),1)
)a
left join 
(
    select
         map_location_id  --'活动位置编号'
        ,location_name    --'活动位置名称'
        ,status           --'状态：0-无效；1-有效'
        ,type             --'类型'
    from dwh_dw_campus.clife_campus_dim_interest_map_location
    where part_date = regexp_replace(date_sub(current_date(),1),'-','')
)b on a.map_location_id = b.map_location_id
left join
(
   select *
   from dwh_dw_campus.clife_campus_dim_student
   where part_date = regexp_replace(date_sub(current_date(),1),'-','')
)c on a.student_id = c.student_id
left join
(
   select *
   from dwh_dw_campus.clife_campus_dim_org
   where part_date = regexp_replace(date_sub(current_date(),1),'-','')
)d on c.org_id = d.org_id
left join
(
   select * from dwh_dw_campus.clife_campus_dim_area
)e on d.area_id = e.area_id


===========================
clife_campus_dwd_classroom_env_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_classroom_env_info partition(part_date)  --校验时，数据量一定是两个发散的综合
select 
   t.class_room_id --'教室id'
  ,t.class_room_name --'教室名称'
  ,t.class_id --'班级id'
  ,g.class_name --'班级name'
  ,t.school_id as org_id --'学校id'
  ,k.org_name --'学校名称'
  ,k.area_id     as   org_area_id        --'学校区县id'
  ,p.area_name   as   org_area_name      --'学校区县id'
  ,intds                    --原水水质
  ,case 
     when intds >=0 and intds <= 10 then '优'
     when intds >10 and intds <=20 then '良'
     when intds >20 and intds <=50 then '合格'
     when intds >50 then '一般'
   else null end as intds_result   --原水水质结论
  ,outtds                          --净水水质
  ,case 
     when outtds <= 10 then '极佳'
     when outtds >=11 and outtds <=50 then '优秀'
     when outtds >=51 and outtds <=300 then '良好'
     when outtds >=301 and outtds <=600 then '一般'
     when outtds >600 then '有待改善'
   else null end as outtds_result   --净水水质结论
  ,air_exhaust_temp       --温度
  ,case 
       when air_exhaust_temp <= 5 then '寒冷'
       when air_exhaust_temp > 5 and air_exhaust_temp <= 18 then '较冷'
       when air_exhaust_temp > 18 and air_exhaust_temp <= 28 then '适宜'
       when air_exhaust_temp > 28 and air_exhaust_temp <= 32 then '较热'
       when air_exhaust_temp > 32 then '炎热'
     else null end as air_exhaust_result   --温度结论
  ,air_exhaust_humidity   --湿度
  ,case 
       when air_exhaust_humidity >= 0 and air_exhaust_humidity <= 40 then '干燥'
       when air_exhaust_humidity > 40 and air_exhaust_humidity <= 75  then '适宜'
       when air_exhaust_humidity > 75 and air_exhaust_humidity <= 100 then '湿润'
     else null end as air_exhausthum_result --湿度结论
  ,co2_value              --CO2
  ,case 
       when co2_value >= 0 and co2_value <= 450 then '优'
       when co2_value > 450 and co2_value <= 800 then '良'
       when co2_value > 800 and co2_value <= 1200 then '轻度'
       when co2_value > 1200 and co2_value <= 2000 then '中度'
       when co2_value > 2000 then '重度'
     else null end as co2_result   --CO2结论
  ,pm25_value             --PM2.5
  ,case 
       when pm25_value >= 0 and pm25_value <= 35 then '优'
       when pm25_value > 35 and pm25_value <= 75 then '良'
       when pm25_value > 75 and pm25_value <= 115 then '轻度'
       when pm25_value > 115 and pm25_value <= 150 then '中度'
       when pm25_value > 150 and pm25_value <= 250 then '重度'
   else null end as pm25_result   --pm25结论  
  ,g.grade_id  			-- ’年级id'
  ,g.grade_name         -- '年级名称'
  ,regexp_replace(date_sub(current_date(),1),'-','') as part_date
from
(
  select * from dwh_ods_campus_new.clife_campus_ods_class_room
  where part_date = regexp_replace(date_sub(current_date(),1),'-','')
) t 
left join 
(
   select 
        position_id as class_room_id
       ,upload_time
       ,avg(air_exhaust_temp) as air_exhaust_temp
       ,avg(air_exhaust_humidity) as air_exhaust_humidity
       ,avg(co2_value) as co2_value
       ,avg(pm25_value) as pm25_value
   from 
   ( 
     select * from dwh_ods_campus_new.clife_campus_ods_fresh_air_machine_run_data 
     where part_date = regexp_replace(date_sub(current_date(),1),'-','') and substr(upload_time,0,10)=date_sub(current_date(),1)
   )a 
   left join
   ( 
      select * from dwh_ods_campus_new.clife_campus_ods_school_device 
      where part_date = regexp_replace(date_sub(current_date(),1),'-','')
   )b on a.device_no = b.device_no 
   where b.position_type = 1
   group by position_id,upload_time
)c on t.class_room_id=c.class_room_id
full join
(
   select 
        position_id as class_room_id
       ,cdate
       ,avg(intds) as intds
       ,avg(outtds) as outtds
   from 
   ( 
     select * from dwh_ods_campus_new.clife_campus_ods_water_drink_record 
     where part_date = regexp_replace(date_sub(current_date(),1),'-','') and substr(create_time,0,10)=date_sub(current_date(),1)
   )d 
   left join
   ( 
      select * from dwh_ods_campus_new.clife_campus_ods_school_device 
      where part_date = regexp_replace(date_sub(current_date(),1),'-','')
   )e on d.device_no = e.device_no 
   where e.position_type = 1
   group by position_id,cdate
)f
on t.class_room_id = f.class_room_id and c.upload_time=f.cdate
left join
(
  select * from dwh_dw_campus.clife_campus_dim_class
  where part_date = regexp_replace(date_sub(current_date(),1),'-','')
)g on t.class_id = g.class_id
left join
(
  select * from dwh_dw_campus.clife_campus_dim_org
  where part_date = regexp_replace(date_sub(current_date(),1),'-','')
)k on t.school_id = k.org_id
left join
(
   select * from dwh_dw_campus.clife_campus_dim_area
)p on p.area_id = k.area_id


===========================
clife_campus_dwd_student_leave_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_student_leave_info partition(part_date)
select  
    b.student_id, --'学生唯一id'
    b.student_name, --'学生姓名'
    b.sex,         --'性别'
    b.age,          --'年龄'
  	b.class_id,     --'班级id'     
  	b.class_name,   --'班级名称'
  	b.grade_id,     --'年级id'
  	b.grade_name,   --'年级名称'
  	b.org_id,       --'学校id'
 	b.org_name,     --'学校名称'
  	b.area_id,      --'学校区县id'
    a.leave_type,     --'类型 2-病假 3-事假'
	a.leave_reason,   --'请假事由'
	a.leave_url,      --'病况资料图片'
	a.leave_duration, --'请假时长天-4-1 '
	a.start_time,     --'开始时间'
	a.end_time,       --'结束时间'
	a.start_time_type, --'请假开始时间类型0-上午1-下午'
	a.end_time_type,    --'请假结束时间类型0-上午1-下午'
	a.teacher_data_id,   --'审批老师主键ID'
	case when a.read_status = 1 then 0 else 1 end,  --'阅读状态0未读1已读'
	case when a.approve_status = 1 then 0 else 1 end,  --'审批状态0未处理1已处理'
	a.approve_date,      --'审批时间'
	a.create_date,       --'创建时间'
	a.update_date,       --'修改时间'
	regexp_replace(date_sub(current_date(),1),'-','') as part_date
from 
 dwh_ods_campus_new.clife_campus_ods_student_leave a
 left join 
 dwh_dw_campus.clife_campus_dim_student b 
 on a.student_id=b.student_id and b.part_date=regexp_replace(date_sub(current_date(),1),'-','') and b.status=1 and b.deleted=1
where a.part_date=regexp_replace(date_sub(current_date(),1),'-','') and substr(a.update_date,1,10)=date_sub(current_date(),1)


===========================
clife_campus_dwd_inspection_stu
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_inspection_stu partition(part_date)
select
 t1.inspection_id      -- '晨午检Id'
,t1.student_id        -- '学生id'
,t1.student_name      -- '姓名'
,t1.sex               -- '性别'
,t1.age               -- '年龄'
,t1.class_id          -- '班级id'
,t1.class_name        -- '班级名称'
,t1.grade_id          -- '年级id'
,t1.grade_name        -- '年级名称'
,t1.org_id            -- '学校id'
,t1.org_name          -- '学校名称'
,t1.org_area_id       -- '学校县区id'
,t1.user_id           -- '检查人Id'
,t1.type              -- '检查类型 0晨检 1午检'
,t1.img               -- '检查图片'
,t1.is_temperature    -- '体温 0正常 1具体温度'
,t1.temperature       -- '体温值(选择具体温度才有值)'
,substr(cast(t1.inspection_date as string),1,10)  inspection_date   -- '检查日期'
,t1.is_abnormal       -- '检查结果 0异常 1正常'
,case when concat(',',symptom_ids,',') like '%,1,%'  then 1 else 0 end fever             -- '发热  1是0否'
,case when concat(',',symptom_ids,',') like '%,2,%'  then 1 else 0 end throat            -- '咽部红肿'
,case when concat(',',symptom_ids,',') like '%,3,%'  then 1 else 0 end hfmd              -- '疑似手口足病'
,case when concat(',',symptom_ids,',') like '%,4,%'  then 1 else 0 end abnormal_rash     -- '异常皮疹'
,case when concat(',',symptom_ids,',') like '%,5,%'  then 1 else 0 end cough             -- '咳嗽'
,case when concat(',',symptom_ids,',') like '%,6,%'  then 1 else 0 end runny_nose        -- '流涕'
,case when concat(',',symptom_ids,',') like '%,7,%'  then 1 else 0 end rash              -- '皮疹'
,case when concat(',',symptom_ids,',') like '%,8,%'  then 1 else 0 end vomit             -- '呕吐'
,case when concat(',',symptom_ids,',') like '%,9,%'  then 1 else 0 end conjunctival      -- '结膜充血，分泌物多'
,case when concat(',',symptom_ids,',') like '%,10,%'  then 1 else 0 end nose_bleeding     -- '流鼻血'
,case when concat(',',symptom_ids,',') like '%,11,%'  then 1 else 0 end trauma            -- '外伤'
,case when concat(',',symptom_ids,',') like '%,12,%'  then 1 else 0 end diarrhea          -- '腹泻'
,case when concat(',',symptom_ids,',') like '%,13,%'  then 1 else 0 end cheek             -- '腮腺肿大' 
,case when concat(',',symptom_ids,',') like '%,14,%'  then 1 else 0 end hand              -- '手部异常'
,case when concat(',',symptom_ids,',') like '%,15,%'  then 1 else 0 end mouth             -- '口腔异常'
,case when concat(',',symptom_ids,',') like '%,16,%'  then 1 else 0 end red_eye           -- '红眼'
,case when concat(',',symptom_ids,',') like '%,17,%'  then 1 else 0 end spirit            -- '精神不佳'
,case when concat(',',symptom_ids,',') like '%,18,%'  then 1 else 0 end fingernail        -- '指甲过长'
,t1.contagion_ids contagions        -- '传染病ids'
,case when concat(',',contagion_ids,',') like '%,6_1,%'  then 1 else 0 end influenza             -- '流行性感冒'
,case when concat(',',contagion_ids,',') like '%,6_3,%'  then 1 else 0 end rubella           -- '风疹'
,case when concat(',',contagion_ids,',') like '%,6_11,%'  then 1 else 0 end contagion_diarrhea            -- '感染性腹泻'
,case when concat(',',contagion_ids,',') like '%,6_10,%'  then 1 else 0 end contagion_hfmd        -- '手口足病'
,case when concat(',',contagion_ids,',') like '%,5_12,%'  then 1 else 0 end dysentery            -- '痢疾'
,case when !(concat(',',contagion_ids,',') like '%,,%' or concat(',',contagion_ids,',') like '%,6_1,%' or concat(',',contagion_ids,',') like '%,6_3,%' or concat(',',contagion_ids,',') like '%,6_11,%' or concat(',',contagion_ids,',')  like '%,6_10,%' or concat(',',contagion_ids,',') like '%,5_12,%')  then 1 else 0 end other_contagions        -- '其他传染病'
,t1.other_symptom     -- '其他症状'
,t1.treatment         -- '处理情况 0家长送医 1留园观察 2停课治疗 3其他'
,t1.other             -- '其他情况'
,t1.deleted           -- '是否删除 0是 1不是'
,t1.status            -- '状态 0已确定 1待确认'
,t1.data_sources      -- '数据来源  0 web录入  1 智能设备 2批量创建 3移动端录入'
,t1.create_time       -- '创建时间'
,t1.update_time       -- '修改时间'
,regexp_replace(date_sub(current_date(),1),'-','') as part_date
from 
(
select 
  a.inspection_id             -- '晨午检Id'
  ,max(a.student_id)    student_id              -- '学生Id'
  ,max(t.student_name)  student_name             -- '姓名'
  ,max(t.sex)           sex                     -- '1-男 2-女 3-其他'
  ,max(t.age)           age              --  '年龄'
  ,max(t.class_id)      class_id                 -- '班级id'
  ,max(t.class_name)    class_name             -- '班级名称'
  ,max(t.grade_id)      grade_id              -- '年级id'
  ,max(t.grade_name)    grade_name             -- '年级名称'
  ,max(t.org_id)        org_id             -- '学校id'
  ,max(t.org_name)      org_name             -- '学校名称'
  ,max(t.area_id)      org_area_id             -- '学校区县id'
  ,max(a.user_id)       user_id            -- '检查人Id'
  ,max(a.type)          type            -- '检查类型 0晨检 1午检'
  ,max(a.img)           img            -- '检查图片'
  ,max(a.is_temperature)    is_temperature        -- '体温 0正常 1具体温度'
  ,max(a.temperature)       temperature        -- '体温值(选择具体温度才有值)'
  ,max(a.inspection_date)   inspection_date        -- '检查日期'
  ,max(a.is_abnormal)       is_abnormal        -- '检查结果 0异常 1正常'
  ,max(a.other_symptom)     other_symptom        -- '其他症状'
  ,max(a.treatment)         treatment        -- '处理情况 0家长送医 1留园观察 2停课治疗 3其他'
  ,max(a.other)             other        -- '其他情况'
  ,max(a.deleted)           deleted        -- '是否删除 0是 1不是'
  ,max(a.status)            status        -- '状态 0已确定 1待确认'
  ,max(a.data_sources)      data_sources        -- '数据来源  0 web录入  1 智能设备 2批量创建 3移动端录入'
  ,max(a.create_time)       create_time        -- '创建时间'
  ,max(a.update_time)       update_time        -- '修改时间'
  ,concat_ws(',',collect_set(cast(b.symptom_id as string))) as symptom_ids   --症状ids
  ,concat_ws(',',collect_set(concat(cast(c.contagion_type as string),'_',cast(c.contagion_id as string)))) as contagion_ids   --传染病ids
  from 
  dwh_ods_campus_new.clife_campus_ods_student_am_inspection a 
  left join 
  dwh_dw_campus.clife_campus_dim_student t
  on a.student_id=t.student_id and t.part_date=regexp_replace(date_sub(current_date(),1),'-','')
  left join 
  dwh_ods_campus_new.clife_campus_ods_student_inspection_symptom b 
  on a.inspection_id=b.inspection_id and b.part_date=regexp_replace(date_sub(current_date(),1),'-','')
  left join 
  dwh_ods_campus_new.clife_campus_ods_inspection_contagion c 
  on a.inspection_id=c.inspection_id and c.part_date=regexp_replace(date_sub(current_date(),1),'-','')
  where a.part_date=regexp_replace(date_sub(current_date(),1),'-','')
  group by a.inspection_id
)   t1


===========================
clife_campus_dwd_sports_amount
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_sports_amount partition(part_date)
select 
   a.data_id                    -- '主键标识'
  ,a.student_id                 -- '学生唯一标识'
  ,b.student_name               -- '姓名'
  ,b.sex                        -- '1-男 2-女 3-其他'
  ,b.age                        --  '年龄'
  ,b.class_id                   -- '班级id'
  ,b.class_name                 -- '班级名称'
  ,b.grade_id                   -- '年级id'
  ,b.grade_name                 -- '年级名称'
  ,b.org_id                     -- '学校id'
  ,b.org_name                   -- '学校名称'
  ,b.area_id                      -- '区县id'
  ,a.device_no                  -- '设备编号'
  ,case when a.sport_num  is null then 0 else  a.sport_num end as  sport_num                -- '运动量'
  ,a.source                     -- '数据来源：1-手环；2-家长APP；3-手表'
  ,a.measure_time               -- '测量时间'
  ,a.upload_time               -- '数据上传时间'
  ,regexp_replace(substr(a.measure_time,0,10),'-','')  as part_date    -- '跑数时间'
from (
select * 
from dwh_ods_campus_new.clife_campus_ods_sport_amount where part_date=regexp_replace(date_sub(current_date(),1),'-','') 
         and substr(measure_time,0,10) > date_sub(current_date(),10)
) a 
left join (
select 
 * 
from dwh_dw_campus.clife_campus_dim_student where part_date > regexp_replace(date_sub(current_date(),10),'-','')
) b 
on a.student_id=b.student_id and regexp_replace(substr(a.measure_time,0,10),'-','')=b.part_date and b.status=1 and b.deleted=1


===========================
clife_campus_dwd_health_stu_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_health_stu_info partition(part_date)
select
   e.data_id
  ,e.student_id                 -- '学生id'
  ,t.student_name               -- '姓名'
  ,t.sex                        -- '1-男 2-女 3-其他'
  ,t.age                        --  '年龄'
  ,t.class_id                   -- '班级id'
  ,t.class_name                 -- '班级名称'
  ,t.grade_id                   -- '年级id'
  ,t.grade_name                 -- '年级名称'
  ,t.org_id                     -- '学校id'
  ,t.org_name                   -- '学校名称'
  ,t.area_id     -- '区县id'
  ,e.serious_disease_his     -- '各种严重病史'
  ,e.serious_disease_his_d      -- '严重病史详情'
  ,e.infectious_disease_his     -- '各种传染病史'
  ,e.infectious_disease_his_d   -- '传染病史详情'
  ,e.weight                     -- '体重（单位：kg）'
  ,e.`level`                    -- '（身材正常状态）  0：偏瘦  1：标准  2：超重  3：肥胖 99-其它'
  ,e.height                     -- '身高（单位：cm）'
  ,e.height_level               -- '（身高状态）  0：偏矮  1：标准  2：偏高'
  ,e.bmi                        -- 'bmi数值'
  ,e.bmi_assess                 -- '身材正常状态）  0：偏瘦  1：标准  2：超重  3：肥胖 99-其它'
  ,e.left_eye                   -- '左眼健康'
  ,e.right_eye                  -- '右眼健康'
  ,e.left_vision                -- '左视力'
  ,e.right_vision               -- '右视力'
  ,e.left_abnormal        -- '左视力健康'
  ,e.right_abnormal        -- '右视力健康'
  ,e.number_of_caries           -- '龋齿数'
  ,e.number_of_teeth            -- '牙齿数量'
  ,e.head_neck     -- ' 头颈'
  ,e.thoracic     -- '胸廓'
  ,e.spine     -- '脊椎'
  ,e.limbs     -- '四肢'
  ,e.pharynx         -- '咽部'
  ,e.heart     -- '心'
  ,e.lung     -- '肺'
  ,e.liver     -- '肝'
  ,e.spleen     -- '脾'
  ,e.hemoglobin     -- '血红蛋白（单位：g/h）'
  ,e.alt     -- '丙氨酸氨基转移酶'
  ,e.lack     -- '接种情况'
  ,e.whether_allergy     --'是否过敏体质，0：否，1：是'
  ,g.allergy_ingredients        -- '过敏食材'
  ,e.date_time  --测量日期
  ,regexp_replace(date_sub(current_date(),1),'-','') as part_date
from
(
  select
       student_id
      ,date_time
      ,serious_disease_his
      ,serious_disease_his_d
      ,infectious_disease_his
      ,infectious_disease_his_d
      ,left_eye
      ,right_eye
      ,number_of_caries
      ,number_of_teeth
      ,head_neck
      ,thoracic
      ,spine
      ,limbs
      ,pharynx
      ,heart
      ,lung
      ,liver
      ,spleen
      ,hemoglobin
      ,alt
      ,lack
      ,whether_allergy
      ,left_vision
      ,right_vision
      ,left_abnormal
      ,right_abnormal
      ,weight
      ,level
      ,height
      ,height_level
      ,bmi
      ,bmi_assess
      ,row_number()over(order by date_time asc) as data_id
   from
   (
     select
          student_id
         ,date_time
         ,max(serious_disease_his)       as serious_disease_his
         ,max(serious_disease_his_d)     as serious_disease_his_d
         ,max(infectious_disease_his)    as infectious_disease_his
         ,max(infectious_disease_his_d)  as infectious_disease_his_d
         ,max(left_eye)                  as left_eye
         ,max(right_eye)                 as right_eye
         ,max(number_of_caries)          as number_of_caries
         ,max(number_of_teeth)           as number_of_teeth
         ,max(head_neck)                 as head_neck
         ,max(thoracic)                  as thoracic
         ,max(spine)                     as spine
         ,max(limbs)                     as limbs
         ,max(pharynx)                   as pharynx
         ,max(heart)                     as heart
         ,max(lung)                      as lung
         ,max(liver)                     as liver
         ,max(spleen)                    as spleen
         ,max(hemoglobin)                as hemoglobin
         ,max(alt)                       as alt
         ,max(lack)                      as lack
         ,max(whether_allergy)           as whether_allergy
         ,max(left_vision)               as left_vision
         ,max(right_vision)              as right_vision
         ,max(left_abnormal)             as left_abnormal
         ,max(right_abnormal)            as right_abnormal
         ,max(weight)                    as weight
         ,max(`level`)                   as level
         ,max(height)                    as height
         ,max(height_level)              as height_level
         ,max(bmi)                       as bmi
         ,max(bmi_assess)                as bmi_assess
     from
     (
       select 
            student_data_id as student_id
           ,serious_disease_his      -- '各种严重病史'
           ,serious_disease_his_d     -- '严重病史详情'
           ,infectious_disease_his    -- '各种传染病史'
           ,infectious_disease_his_d  -- '传染病史详情'
           ,left_eye                  -- '左眼健康'
           ,right_eye                 -- '右眼健康'
           ,number_of_caries          -- '龋齿数'
           ,number_of_teeth           -- '牙齿数量'
           ,head_neck  -- ' 头颈'
           ,thoracic  -- '胸廓'
           ,spine  -- '脊椎'
           ,limbs  -- '四肢'
           ,pharynx  -- '咽部'
           ,heart  -- '心'
           ,lung      -- '肺'
           ,liver  -- '肝'
           ,spleen  -- '脾'
           ,hemoglobin  -- '血红蛋白（单位：g/h）'
           ,alt  -- '丙氨酸氨基转移酶'
           ,lack      -- '接种情况'
           ,whether_allergy  --'是否过敏体质，0：否，1：是'
           ,null as left_vision       -- '左视力'
           ,null as right_vision      -- '右视力'
           ,null as left_abnormal     -- '左视力健康'
           ,null as right_abnormal
           ,null as weight      
           ,null as `level`     
           ,null as height      
           ,null as height_level
           ,null as bmi
           ,null as bmi_assess
           ,date_time
       from
       (
         select 
              t1.student_data_id
             ,concat_ws(',',collect_list(cast(t1.serious_disease_his as string))) as serious_disease_his
             ,concat_ws(',',collect_list(cast(t1.serious_disease_his_d as string))) as serious_disease_his_d
             ,concat_ws(',',collect_list(cast(t1.infectious_disease_his as string))) as infectious_disease_his
             ,concat_ws(',',collect_list(cast(t1.infectious_disease_his_d as string))) as infectious_disease_his_d
             ,concat_ws(',',collect_list(cast(t1.left_eye as string))) as left_eye
             ,concat_ws(',',collect_list(cast(t1.right_eye as string))) as right_eye
             ,concat_ws(',',collect_list(cast(t1.number_of_caries as string))) as number_of_caries
             ,concat_ws(',',collect_list(cast(t1.number_of_teeth as string))) as number_of_teeth
             ,concat_ws(',',collect_list(cast(t1.head_neck as string))) as head_neck
             ,concat_ws(',',collect_list(cast(t1.thoracic as string))) as thoracic
             ,concat_ws(',',collect_list(cast(t1.spine as string))) as spine
             ,concat_ws(',',collect_list(cast(t1.limbs as string))) as limbs
             ,concat_ws(',',collect_list(cast(t1.pharynx as string))) as pharynx
             ,concat_ws(',',collect_list(cast(t1.heart as string))) as heart
             ,concat_ws(',',collect_list(cast(t1.lung as string))) as lung
             ,concat_ws(',',collect_list(cast(t1.liver as string))) as liver
             ,concat_ws(',',collect_list(cast(t1.spleen as string))) as spleen
             ,concat_ws(',',collect_list(cast(t1.hemoglobin as string))) as hemoglobin
             ,concat_ws(',',collect_list(cast(t1.alt as string))) as alt
             ,concat_ws(',',collect_list(cast(t1.lack as string))) as lack
             ,concat_ws(',',collect_list(cast(t1.whether_allergy as string))) as whether_allergy
             ,substr(if(t1.update_time is null,t1.create_time,t1.update_time),1,10) as date_time
         from dwh_ods_campus.clife_campus_ods_stu_health t1
         where t1.part_date=regexp_replace(date_sub(current_date(),1),'-','') 
           and t1.status=1 
           and t1.deleted=1
         group by t1.student_data_id
                 ,substr(if(t1.update_time is null,t1.create_time,t1.update_time),1,10)
       )a
       union all
       select 
            student_id
           ,null as serious_disease_his      -- '各种严重病史'
           ,null as serious_disease_his_d     -- '严重病史详情'
           ,null as infectious_disease_his    -- '各种传染病史'
           ,null as infectious_disease_his_d  -- '传染病史详情'
           ,null as left_eye                  -- '左眼健康'
           ,null as right_eye                 -- '右眼健康'
           ,null as number_of_caries          -- '龋齿数'
           ,null as number_of_teeth           -- '牙齿数量'
           ,null as head_neck  -- ' 头颈'
           ,null as thoracic  -- '胸廓'
           ,null as spine  -- '脊椎'
           ,null as limbs  -- '四肢'
           ,null as pharynx  -- '咽部'
           ,null as heart  -- '心'
           ,null as lung      -- '肺'
           ,null as liver  -- '肝'
           ,null as spleen  -- '脾'
           ,null as hemoglobin  -- '血红蛋白（单位：g/h）'
           ,null as alt  -- '丙氨酸氨基转移酶'
           ,null as lack      -- '接种情况'
           ,null as whether_allergy  --'是否过敏体质，0：否，1：是'
           ,left_vision                -- '左视力'
           ,right_vision               -- '右视力'
           ,left_abnormal     -- '左视力健康'
           ,right_abnormal
           ,null as weight      
           ,null as `level`     
           ,null as height      
           ,null as height_level
           ,null as bmi
           ,null as bmi_assess
           ,date_time
       from
       (
          select
               student_id
              ,concat_ws(',',collect_list(cast(pl.left_vision as string))) as left_vision
              ,concat_ws(',',collect_list(cast(pl.right_vision as string))) as right_vision
              ,concat_ws(',',collect_list(cast(pl.left_abnormal as string))) as left_abnormal
              ,concat_ws(',',collect_list(cast(pl.right_abnormal as string))) as right_abnormal
              ,date_time
          from
          (
            select 
                 student_id
                ,left_vision                -- '左视力'
                ,right_vision               -- '右视力'
                ,case when t1.left_abnormal =0 then 2 else  t1.left_abnormal end left_abnormal     -- '左视力健康'
                ,case when t1.right_abnormal =0 then 2 else t1.right_abnormal end right_abnormal
                ,substr(if(measure_time is null,cast(upload_time as date),measure_time),1,10) as date_time
            from dwh_ods_campus_new.clife_campus_ods_vision_data t1
            where part_date=regexp_replace(date_sub(current_date(),1),'-','')
          )pl
          group by student_id
                  ,date_time
       )b
       union all
       select 
            student_id
           ,null as serious_disease_his      -- '各种严重病史'
           ,null as serious_disease_his_d     -- '严重病史详情'
           ,null as infectious_disease_his    -- '各种传染病史'
           ,null as infectious_disease_his_d  -- '传染病史详情'
           ,null as left_eye                  -- '左眼健康'
           ,null as right_eye                 -- '右眼健康'
           ,null as number_of_caries          -- '龋齿数'
           ,null as number_of_teeth           -- '牙齿数量'
           ,null as head_neck  -- ' 头颈'
           ,null as thoracic  -- '胸廓'
           ,null as spine  -- '脊椎'
           ,null as limbs  -- '四肢'
           ,null as pharynx  -- '咽部'
           ,null as heart  -- '心'
           ,null as lung      -- '肺'
           ,null as liver  -- '肝'
           ,null as spleen  -- '脾'
           ,null as hemoglobin  -- '血红蛋白（单位：g/h）'
           ,null as alt  -- '丙氨酸氨基转移酶'
           ,null as lack      -- '接种情况'
           ,null as whether_allergy  --'是否过敏体质，0：否，1：是'
           ,null as left_vision       -- '左视力'
           ,null as right_vision      -- '右视力'
           ,null as left_abnormal     -- '左视力健康'
           ,null as right_abnormal
           ,weight      
           ,`level`     
           ,height      
           ,height_level
           ,bmi
           ,bmi_assess    
           ,date_time
       from
       (
          select
             student_id
            ,concat_ws(',',collect_list(cast(pl.weight as string)))       as weight
            ,concat_ws(',',collect_list(cast(pl.level as string)))        as level
            ,concat_ws(',',collect_list(cast(pl.height as string)))       as height
            ,concat_ws(',',collect_list(cast(pl.height_level as string))) as height_level
            ,concat_ws(',',collect_list(cast(pl.bmi as string)))          as bmi
            ,concat_ws(',',collect_list(cast(pl.bmi_assess as string)))   as bmi_assess
            ,date_time
          from
          (
            select 
                 t1.student_id
                ,t1.weight      
                ,t1.`level`     
                ,t1.height      
                ,t1.height_level
                ,t1.bmi
                ,case when t1.bmi< f.value1 then 0 
                      when t1.bmi>=f.value1 and t1.bmi<f.value3 then 1
                      when t1.bmi>=f.value3 and t1.bmi<f.value4 then 2
                      when t1.bmi>=f.value4 then 3
                 else null end as bmi_assess      
                ,substr(if(t1.measure_time is null,t1.upload_time,t1.measure_time),1,10) as date_time          
            from dwh_ods_campus_new.clife_campus_ods_student_body_data t1
            left join dwh_dw_campus.clife_campus_dim_student t2 on t1.student_id = t2.student_id and t2.part_date=regexp_replace(date_sub(current_date(),1),'-','')
            left join dwh_ods_campus_new.clife_campus_ods_public_standard_bmi f on t2.sex=f.bmi_sex and t2.age=f.bmi_age and  t2.`month`=f.`month` and f.bmi_type=1 
            where t1.part_date=regexp_replace(date_sub(current_date(),1),'-','') and t1.status=1
          )pl
          group by student_id
                  ,date_time
       )c 
     )d
     group by student_id
             ,date_time  
   )p
)e 
left join 
(
  select *
  from dwh_dw_campus.clife_campus_dim_student
  where part_date=regexp_replace(date_sub(current_date(),1),'-','') 
    and status=1 
    and deleted=1
)t on t.student_id=e.student_id
left join 
(
  select 
       b1.student_id
      ,concat_ws(',',collect_list(cast(b1.ingredient_id as string))) as allergy_ingredients 
  from dwh_ods_campus.clife_campus_ods_student_allergy_ingredients b1 
  where b1.part_date=regexp_replace(date_sub(current_date(),1),'-','') 
  group by b1.student_id 
)g on t.student_id=g.student_id


===========================
clife_campus_dwd_student_medicine_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_medicine_data partition(part_date)
select 
    a.data_id                                                  , -- 唯一标识
    a.medication_date                                          , -- 喂药日期
    a.whether_inspect                                          , -- 药品是否视检,0:否，1：是
    a.medication_reasons                                       , -- 用药原因
    a.number_of_feeding                                        , -- 喂药次数
    a.deleted                                                  , -- 0：删除，1：正常
    a.status                                                   , -- 1-待视检、2-已撤销、3-已视检、4-已完成
    a.source                                                   , -- 0-老师录入，1-家长录入
    a.update_time                                              , -- 更新时间
    a.create_time                                              , -- 创建时间
    a.parent_sign_url                                          , -- 家长签字图片  
    b.medicine_name_list                                       ,  -- 药物名称                         
    b.medication_time_list                                     ,  -- 用药时间                         
    b.medication_method_list                                   ,  -- 用药方式，0：口服，1：外用       
    b.dosage_list                                              ,  -- 用药剂量                         
    b.unit_list                                                ,  -- 单位，0：包，1：颗，2：滴，3：ml 
    b.picture_url_list                                         ,  -- 药物图片url                                    
    b.uncomplete_medicine_cnt                                  ,  -- 待喂药次数                       
    b.complete_medicine_cnt                                    ,  -- 已喂药次数                       
    b.total_cnt                                                ,  -- 总共喂药次数                       
    b.am_cnt                                                   ,  -- 早上喂药次数                     
    b.mid_cnt                                                  ,  -- 中午喂药次数
    c.student_id                                               ,  -- 学生唯一id
    c.student_name                                             ,  -- 学生姓名
    c.sex                                                      ,  -- 性别
    c.age                                                      ,  -- 年龄
    c.class_id                                                 ,  -- 班级id
    c.class_name                                               ,  -- 班级名称
    c.grade_id                                                 ,  -- 年级id
    c.grade_name                                               ,  -- 年级名称
    c.org_id                                                   ,  -- 学校id
    c.org_name                                                 ,  -- 学校名称
    c.area_id                                                  ,  -- 学校区县id
    case when d.am_status is null then 0 else d.am_status end  am_status   ,      -- '是否入园'
    regexp_replace(a.medication_date,'-','')                   ,  -- 喂药分区日期，（等同于喂药日期）  
    regexp_replace(date_sub(current_date(),1),'-','')  as part_date    -- 跑数日期
from dwh_ods_campus.clife_campus_ods_medicine a
left join (
  select 
    feeding_id                                                                                            ,  -- 喂药id
    concat_ws(',',collect_list(cast(medicine_name        as string)))   as        medicine_name_list      ,  -- 药物名称                                       
    concat_ws(',',collect_list(cast(medication_time      as string)))   as        medication_time_list    ,  -- 用药时间                                       
    concat_ws(',',collect_list(cast(medication_method    as string)))   as        medication_method_list  ,  -- 用药方式，0：口服，1：外用                     
    concat_ws(',',collect_list(cast(dosage               as string)))   as        dosage_list             ,  -- 用药剂量                                       
    concat_ws(',',collect_list(cast(unit                 as string)))   as        unit_list               ,  -- 单位，0：包，1：颗，2：滴，3：ml               
    concat_ws(',',collect_list(cast(picture_url          as string)))   as        picture_url_list        ,  -- 药物图片url                                                                  
    sum(case medication_status when 0 then 1 else 0 end)                as        uncomplete_medicine_cnt ,  -- 待喂药次数                                   
    sum(case medication_status when 1 then 1 else 0 end)                as        complete_medicine_cnt   ,  -- 已喂药次数   
    count(*)                                                            as        total_cnt               ,     -- 总共喂药次数
    sum(case moment when 0 then 1 else 0 end)                           as        am_cnt                  ,  -- 早上喂药次数                                   
    sum(case moment when 1 then 1 else 0 end)                           as        mid_cnt                    -- 中午喂药次数
  from dwh_ods_campus.clife_campus_ods_medicine_details 
  where part_date = regexp_replace(date_sub(current_date(),1),'-','') and status = 1 
  --    and substr(medication_time,0,10) = date_sub(current_date(),1)
  group by feeding_id
) b
on a.data_id = b.feeding_id 
left join dwh_dw_campus.clife_campus_dim_student c 
on a.student_id = c.student_id 
        and c.deleted=1 and c.status=1 and c.part_date = regexp_replace(date_sub(current_date(),1),'-','')
left join dwh_dw_campus.clife_campus_dim_into_campus_detail d 
on c.student_id=d.student_id 
        and d.part_date=regexp_replace(date_sub(current_date(),1),'-','') and d.am_status = 1 and d.data_time=date_sub(current_date(),1)
where a.deleted = 1 and a.part_date = regexp_replace(date_sub(current_date(),1),'-','') and a.medication_date = date_sub(current_date(),1)  
union all 
select 
    data_id                                                  , -- 唯一标识
    medication_date                                          , -- 喂药日期
    whether_inspect                                          , -- 药品是否视检,0:否，1：是
    medication_reasons                                       , -- 用药原因
    number_of_feeding                                        , -- 喂药次数
    deleted                                                  , -- 0：删除，1：正常
    status                                                   , -- 1-待视检、2-已撤销、3-已视检、4-已完成
    source                                                   , -- 0-老师录入，1-家长录入
    update_time                                              , -- 更新时间
    create_time                                              , -- 创建时间
    parent_sign_url                                          , -- 家长签字图片  
    medicine_name_list                                       ,  -- 药物名称                         
    medication_time_list                                     ,  -- 用药时间                         
    medication_method_list                                   ,  -- 用药方式，0：口服，1：外用       
    dosage_list                                              ,  -- 用药剂量                         
    unit_list                                                ,  -- 单位，0：包，1：颗，2：滴，3：ml 
    picture_url_list                                         ,  -- 药物图片url                                    
    uncomplete_medicine_cnt                                  ,  -- 待喂药次数                       
    complete_medicine_cnt                                    ,  -- 已喂药次数                       
    total_cnt                                                ,  -- 总共喂药次数                       
    am_cnt                                                   ,  -- 早上喂药次数                     
    mid_cnt                                                  ,  -- 中午喂药次数
    student_id                                               ,  -- 学生唯一id
    student_name                                             ,  -- 学生姓名
    sex                                                      ,  -- 性别
    age                                                      ,  -- 年龄
    class_id                                                 ,  -- 班级id
    class_name                                               ,  -- 班级名称
    grade_id                                                 ,  -- 年级id
    grade_name                                               ,  -- 年级名称
    org_id                                                   ,  -- 学校id
    org_name                                                 ,  -- 学校名称
    area_id                                                  ,  -- 学校区县id
    am_status                                                ,  -- '是否入园'
    medication_part_date                                     ,  -- 喂药分区日期，（等同于喂药日期）  
    regexp_replace(date_sub(current_date(),1),'-','')  as part_date    -- 跑数日期
from dwh_dw_campus.clife_campus_dwd_medicine_data aas
where part_date = regexp_replace(date_sub(current_date(),2),'-','')


===========================
clife_campus_dwd_push_message_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_push_message_info partition(part_date)
select
     a.data_id         --   '自增主键'
    ,a.user_id         --   '用户id'
    ,a.user_name       --   '用户名
    ,a.student_id      --   '学生id'
    ,a.student_name    --   '学生名称'
    ,a.message_id      --   '消息id'
    ,b.app_name        --   '应用名称'
    ,b.title           --   '标题'
    ,b.summary         --   '概要，简单描述'
    ,b.sender          --   '发送者(系统发送的sender为0)'
    ,b.message_type    --   '消息类型'
    ,b.business_param  --   '业务参数的值json格式'
    ,b.content_type    --   '消息内容类型(0 - 富文本方式; 1 - 跳转消息)'
    ,b.data_flag       --   '数据来源标识（默认为0-普通推送消息；1-园丁端老师；2-校园运营端）'   
    ,a.status          --   '消息状态（0-删除，1-未读，2-已读）'
    ,a.org_id          --   '机构id'
    ,a.org_name        --   '学校名称'
    ,a.grade_id        --   '年级集合'
    ,a.grade_name      --   '年级名称集合'
    ,a.class_id        --   '班级集合'
    ,a.class_name      --   '班级名称集合'
    ,a.user_type       --   '用户类型'
    ,a.create_time     --   '创建时间'
    ,a.update_time     --   '更新时间'
    ,regexp_replace(date_sub(current_date(),1),'-','') as part_date
from 
(
  select
       t.data_id         --   '自增主键'
      ,t.user_id         --   '用户id'
      ,t1.user_name      --   '用户名'
      ,t.student_id      --   '学生id'
      ,null as student_name 
      ,t.org_id          --   '机构id'
      ,t.message_id      --   '消息id'
      ,t.status          --   '消息状态（0-删除，1-未读，2-已读）'
      ,t.user_type       --   '2-家长'
      ,t.create_time     --   '创建时间'
      ,t.update_time     --   '更新时间'
      ,t1.org_name       --   '学校名称'
      ,t1.grade_id_list   as grade_id    --   '年级集合'
      ,t1.grade_name_list as grade_name  --   '年级名称集合'
      ,t1.class_id_list   as class_id    --   '班级集合'
      ,t1.class_name_list as class_name  --   '班级名称集合'
  from dwh_ods_campus.clife_campus_ods_message_user t
  left join 
  (
    select 
         user_id
        ,org_id
        ,concat_ws(';',collect_list(cast(a.class_id as string))) as class_id_list
        ,concat_ws(';',collect_list(cast(b.class_name as string))) as class_name_list
        ,concat_ws(';',collect_list(cast(b.grade_id as string))) as grade_id_list
        ,concat_ws(';',collect_list(cast(b.grade_name as string))) as grade_name_list
        ,max(b.org_name) as org_name -- '学校名称'
        ,max(c.real_name) as user_name
    from dwh_ods_campus.clife_campus_ods_user_class a
    left join dwh_dw_campus.clife_campus_dim_class b on a.org_id = b.org_id and a.class_id = b.class_id and b.part_date=regexp_replace(date_sub(current_date(),1),'-','')
    left join dwh_ods_campus.clife_campus_ods_user c on a.user_id=c.user_id and c.part_date=regexp_replace(date_sub(current_date(),1),'-','')
    where a.part_date=regexp_replace(date_sub(current_date(),1),'-','')
    group by a.user_id,a.org_id
  )t1 on t.org_id = t1.org_id and t.user_id = t1.user_id
  where (t.user_type = 1 or t.user_type = 3) and t.part_date=regexp_replace(date_sub(current_date(),1),'-','')
  union all
  select
       t3.data_id         -- '自增主键'
      ,t3.user_id         -- '用户id'
      ,null as user_name  -- '用户名称'
      ,t3.student_id      -- '学生id'
      ,t4.student_name    -- '名称'
      ,t3.org_id          -- '机构id'
      ,t3.message_id      -- '消息id'
      ,t3.status          -- '消息状态（0-删除，1-未读，2-已读）'
      ,t3.user_type       -- '2-家长'
      ,t3.create_time     -- '创建时间'
      ,t3.update_time     -- '更新时间'
      ,t4.org_name        -- '学校名称'
      ,cast(t4.grade_id   as string) as grade_id      -- '年级id'
      ,cast(t4.grade_name as string) as grade_name    -- '年级名称'
      ,cast(t4.class_id   as string) as class_id      -- '班级id'
      ,cast(t4.class_name as string) as class_name    -- '班级名称'
  from dwh_ods_campus.clife_campus_ods_message_user t3
  left join dwh_dw_campus.clife_campus_dim_student t4 on t3.student_id = t4.student_id and t4.part_date=regexp_replace(date_sub(current_date(),1),'-','')
  where t3.user_type = 2 and t3.part_date=regexp_replace(date_sub(current_date(),1),'-','')
)a
left join dwh_ods_campus.clife_campus_ods_message b on a.message_id = b.message_id and b.status=1 and b.part_date=regexp_replace(date_sub(current_date(),1),'-','')


===========================
clife_campus_dwd_student_shit_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_student_shit_info partition(part_date)
select
     b.date_id
    ,b.student_id      --'学生唯一标识'
    ,a.student_name      --'学生名称'
    ,a.sex             --'性别'
    ,a.age             --'年龄'
    ,a.class_id        --'班级id'     
    ,a.class_name      --'班级名称'
    ,a.grade_id        --'年级id'
    ,a.grade_name      --'年级名称'
    ,a.org_id          --'学校id'
    ,a.org_name        --'学校名称'
    ,a.area_id         --'学校区县id'
    ,b.device_no       --'设备编号'
    ,b.shit_cnt        --拉臭臭次数
    ,b.card_times      --'刷卡时间(本地)'
    ,b.length_times    --'多次间隔时长'
    ,c.am_status       --'入园状态'
    ,c.att_status      --'考勤入园状态'
    ,b.date_time       --'上传日期'
    ,regexp_replace(date_sub(current_date(),1),'-','')  as part_date     --'数据日期'
from 
(
   select
        student_id
       ,device_no
       ,shit_cnt
       ,card_times
       ,length_times
       ,date_time
       ,row_number()over(order by date_time asc) as date_id
   from
   (
     select 
          student_id
         ,max(device_no) as device_no
         ,count(1) as shit_cnt --次数
         ,concat_ws(',',collect_list(cast(t.card_time as string)))   as card_times
         ,concat_ws(',',collect_list(cast(t.length_time as string)))   as length_times
         ,date_time  --天数
     from
     (
        select
             student_id
            ,device_no
            ,substr(upload_time,1,10) as date_time
            ,card_time
            ,coalesce(CAST((unix_timestamp(card_time) - unix_timestamp(lag(card_time, 1, null) over (partition by student_id order by card_time))) % 60 AS int),0) as length_time --多次上厕所的间隔时长(秒)
        from dwh_ods_campus.clife_campus_ods_shit_card_data 
        where part_date = regexp_replace(date_sub(current_date(),1),'-','') 
          and status = 1
     )t
     group by student_id
             ,date_time
   )p
)b 
left join  dwh_ods_campus.clife_campus_ods_into_campus_detail c on c.student_id = b.student_id and c.part_date=regexp_replace(date_sub(current_date(),1),'-','') and c.data_time=b.date_time
left join dwh_dw_campus.clife_campus_dim_student a on b.student_id = a.student_id
where a.part_date=regexp_replace(date_sub(current_date(),1),'-','')
  and a.status=1 and a.deleted=1


===========================
clife_campus_dwd_student_intocampus_info
===========================
insert overwrite table dwh_dw_campus.clife_campus_dwd_student_intocampus_info partition(part_date)
select
    b.record_id      --入园记录
   ,b.student_id   --学生id
   ,a.student_name --'学生姓名'
   ,a.sex          --'性别'
   ,a.age          --'年龄'
   ,a.class_id     --'班级id'     
   ,a.class_name   --'班级名称'
   ,a.grade_id     --'年级id'
   ,a.grade_name   --'年级名称'
   ,a.org_id       --'学校id'
   ,a.org_name     --'学校名称'
   ,a.area_id      --'学校区县id'
   ,b.am_status    --'入园状态'
   ,b.att_status   --'考勤入园状态'
   ,b.am_time      --'入园时间'
   ,b.`type`       --'条件类型'
   ,b.create_time  --'创建时间'
   ,b.value        --'数据值'
   ,b.data_time    --日期
   ,regexp_replace(date_sub(current_date(),1),'-','') as part_date --日期
from dwh_ods_campus_new.clife_campus_ods_into_campus_detail b 
left join  dwh_dw_campus.clife_campus_dim_student a on a.student_id=b.student_id and a.part_date=regexp_replace(date_sub(current_date(),1),'-','') 
where b.part_date=regexp_replace(date_sub(current_date(),1),'-','')
 and a.status=1 and a.deleted=1
 and b.data_time <=date_sub(current_date(),1)


===========================
clife_campus_dws_health_stu
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_health_stu  partition(part_date)
select 
   t.class_id                   -- '班级id'
  ,max(t.class_name)                 -- '班级名称'
  ,max(t.grade_id)                   -- '年级id'
  ,max(t.grade_name)                 -- '年级名称'
  ,max(t.org_id)                     -- '学校id'
  ,max(t.org_name)                   -- '学校名称'
  ,max(t.area_id) 				     -- '区县id'
  ,sum(t.serious_disease_his)     -- '有严重病史'
  ,sum(t.infectious_disease_his)   -- '有传染病史'
  ,sum(t.weight_fat_assess)             -- '3：肥胖 '
  ,sum(t.weight_high_assess)             -- '2：超重 '
  ,sum(t.weight_mid_assess)             -- '1：标准 '
  ,sum(t.weight_low_assess)             -- '0：偏瘦 '	  
  ,sum(t.hight_high_assess)             -- '偏高'
  ,sum(t.hight_mid_assess)             -- '标准'
  ,sum(t.hight_low_assess)             -- '偏矮'
  ,sum(t.bmi_fat_assess)             -- '3：肥胖 '
  ,sum(t.bmi_high_assess)             -- '2：超重 '
  ,sum(t.bmi_mid_assess)             -- '1：标准 '
  ,sum(t.bmi_low_assess)             -- '0：偏瘦 '	
  ,sum(t.left_eye_nd) 				     -- '左眼健康未检测'
  ,sum(t.left_eye_normal) 				 -- '左眼健康正常'
  ,sum(t.left_eye_blister) 		     -- '左眼砂眼'
  ,sum(t.left_eye_conjunctivitis) 		 -- '左眼结膜炎'
  ,sum(t.right_eye_nd) 				     -- '右眼健康未检测'
  ,sum(t.right_eye_normal) 				 -- '右眼健康正常'
  ,sum(t.right_eye_blister) 		         -- '右眼砂眼'
  ,sum(t.right_eye_conjunctivitis) 		 -- '右眼结膜炎'  
  ,sum(t.left_normal)                -- '左视力正常'
  ,sum(t.left_abnormal)              -- '左视力异常'
  ,sum(t.right_normal)              -- '右视力正常'
  ,sum(t.right_abnormal)            -- '右视力异常'
  ,sum(t.caries)          -- '患龋齿'
  ,sum(t.head_neck_nd)			 -- ' 头颈正常'
  ,sum(t.head_neck_normal)			 -- ' 头颈正常'
  ,sum(t.head_neck_abnormal)	     -- ' 头颈异常'
  ,sum(t.thoracic_nd)			 -- '胸廓正常'
  ,sum(t.thoracic_normal)			 -- '胸廓正常'
  ,sum(t.thoracic_abnormal)			 -- '胸廓异常'
  ,sum(t.spine_nd)			    -- '脊椎正常'
  ,sum(t.spine_normal)			 -- '脊椎正常'
  ,sum(t.spine_abnormal)		 -- '脊椎异常'
  ,sum(t.limbs_nd)			    -- '四肢正常'
  ,sum(t.limbs_normal)			 -- '四肢正常'
  ,sum(t.limbs_abnormal)		 -- '四肢异常'
  ,sum(t.pharynx_nd	)	     -- '咽部正常'
  ,sum(t.pharynx_normal	)	 -- '咽部正常'
  ,sum(t.pharynx_abnormal)		 -- '咽部异常'
  ,sum(t.heart_nd)			 -- '心正常'
  ,sum(t.heart_normal)			 -- '心正常'
  ,sum(t.heart_abnormal)		 -- '心异常'
  ,sum(t.lung_nd)		     -- '肺正常'
  ,sum(t.lung_normal)		     -- '肺正常'
  ,sum(t.lung_abnormal)		     -- '肺异常'
  ,sum(t.liver_nd)			 -- '肝正常'
  ,sum(t.liver_normal)			 -- '肝正常'
  ,sum(t.liver_abnormal)	     -- '肝异常'
  ,sum(t.spleen_nd)			 -- '脾正常'
  ,sum(t.spleen_normal)			 -- '脾正常'
  ,sum(t.spleen_abnormal)		 -- '脾异常'
  ,sum(t.alt_nd)		     -- '丙氨酸氨基转移酶正常'
  ,sum(t.alt_normal)		     -- '丙氨酸氨基转移酶正常'  
  ,sum(t.alt_abnormal)		     -- '丙氨酸氨基转移酶异常'
  ,sum(t.lack)		 -- '接种'
  ,sum(t.whether_allergy)			 --'过敏体质'
  ,sum(t.no_whether_allergy)		 --'非过敏体质'
  ,sum(t.allergy_ingredients)        -- '食材过敏'
  ,count(t.student_id)               -- '学生人数'
  ,regexp_replace(date_sub(current_date(),1),'-','')
from
( 
select 
   student_id                 -- '学生id'
  ,class_id                   -- '班级id'
  ,class_name                 -- '班级名称'
  ,grade_id                   -- '年级id'
  ,grade_name                 -- '年级名称'
  ,org_id                     -- '学校id'
  ,org_name                   -- '学校名称'
  ,area_id 				     -- '区县id'
  ,case when serious_disease_his =1 then 1 else 0 end 	serious_disease_his     -- '有严重病史'
  ,case when infectious_disease_his =1 then 1 else 0 end  infectious_disease_his   -- '有传染病史'
  ,case when weight_assess =3 then 1 else 0 end weight_fat_assess             -- '3：肥胖 '
  ,case when weight_assess =2 then 1 else 0 end weight_high_assess             -- '2：超重 '
  ,case when weight_assess =1 then 1 else 0 end weight_mid_assess             -- '1：标准 '
  ,case when weight_assess =0 then 1 else 0 end weight_low_assess             -- '0：偏瘦 '	  
  ,case when height_assess =2 then 1 else 0 end hight_high_assess             -- '偏高'
  ,case when height_assess =1 then 1 else 0 end hight_mid_assess             -- '标准'
  ,case when height_assess =0 then 1 else 0 end hight_low_assess             -- '偏矮'
  ,case when bmi_assess =3 then 1 else 0 end bmi_fat_assess             -- '3：肥胖 '
  ,case when bmi_assess =2 then 1 else 0 end bmi_high_assess             -- '2：超重 '
  ,case when bmi_assess =1 then 1 else 0 end bmi_mid_assess             -- '1：标准 '
  ,case when bmi_assess =0 then 1 else 0 end bmi_low_assess             -- '0：偏瘦 '	
  ,case when left_eye =0 then 1 else 0 end left_eye_nd 				     -- '左眼健康未检测'
  ,case when left_eye =1 then 1 else 0 end left_eye_normal 				 -- '左眼健康正常'
  ,case when left_eye =2 then 1 else 0 end left_eye_blister 		     -- '左眼砂眼'
  ,case when left_eye =3 then 1 else 0 end left_eye_conjunctivitis 		 -- '左眼结膜炎'
  ,case when right_eye =0 then 1 else 0 end right_eye_nd 				     -- '右眼健康未检测'
  ,case when right_eye =1 then 1 else 0 end right_eye_normal 				 -- '右眼健康正常'
  ,case when right_eye =2 then 1 else 0 end right_eye_blister 		         -- '右眼砂眼'
  ,case when right_eye =3 then 1 else 0 end right_eye_conjunctivitis 		 -- '右眼结膜炎'  
  ,case when left_abnormal =1  then 1 else 0 end left_normal                -- '左视力正常'
  ,case when left_abnormal =2  then 1 else 0 end left_abnormal              -- '左视力异常'
  ,case when right_abnormal =1  then 1 else 0 end right_normal              -- '右视力正常'
  ,case when right_abnormal =2  then 1 else 0 end right_abnormal            -- '右视力异常'
  ,case when number_of_caries >0 then 1 else 0 end caries          -- '患龋齿'
  ,case when head_neck 	=0 then 1 else 0 end  head_neck_nd			 -- ' 头颈正常'
  ,case when head_neck 	=1 then 1 else 0 end  head_neck_normal			 -- ' 头颈正常'
  ,case when head_neck 	=2 then 1 else 0 end  head_neck_abnormal	     -- ' 头颈异常'
  ,case when thoracic 	=0 then 1 else 0 end  thoracic_nd			 -- '胸廓正常'
  ,case when thoracic 	=1 then 1 else 0 end  thoracic_normal			 -- '胸廓正常'
  ,case when thoracic 	=2 then 1 else 0 end  thoracic_abnormal			 -- '胸廓异常'
  ,case when spine 		=0 then 1 else 0 end  spine_nd  			 -- '脊椎正常'
  ,case when spine 		=1 then 1 else 0 end  spine_normal			 -- '脊椎正常'
  ,case when spine 		=2 then 1 else 0 end  spine_abnormal		 -- '脊椎异常'
  ,case when limbs 		=1 then 1 else 0 end  limbs_nd  			 -- '四肢正常'
  ,case when limbs 		=1 then 1 else 0 end  limbs_normal			 -- '四肢正常'
  ,case when limbs 		=2 then 1 else 0 end  limbs_abnormal		 -- '四肢异常'
  ,case when pharynx 	=0 then 1 else 0 end  pharynx_nd    		 -- '咽部正常'
  ,case when pharynx 	=1 then 1 else 0 end  pharynx_normal		 -- '咽部正常'
  ,case when pharynx 	=2 then 1 else 0 end  pharynx_abnormal		 -- '咽部异常'
  ,case when heart 		=0 then 1 else 0 end  heart_nd  			 -- '心正常'
  ,case when heart 		=1 then 1 else 0 end  heart_normal			 -- '心正常'
  ,case when heart 		=2 then 1 else 0 end  heart_abnormal		 -- '心异常'
  ,case when lung 		=0 then 1 else 0 end  lung_nd    		     -- '肺正常'
  ,case when lung 		=1 then 1 else 0 end  lung_normal		     -- '肺正常'
  ,case when lung 		=2 then 1 else 0 end  lung_abnormal		     -- '肺异常'
  ,case when liver 		=0 then 1 else 0 end  liver_nd  			 -- '肝正常'
  ,case when liver 		=1 then 1 else 0 end  liver_normal			 -- '肝正常'
  ,case when liver 		=2 then 1 else 0 end  liver_abnormal	     -- '肝异常'
  ,case when spleen 	=0 then 1 else 0 end  spleen_nd 			 -- '脾正常'
  ,case when spleen 	=1 then 1 else 0 end  spleen_normal			 -- '脾正常'
  ,case when spleen 	=2 then 1 else 0 end  spleen_abnormal		 -- '脾异常'
  ,case when alt 		=0 then 1 else 0 end  alt_nd		     -- '丙氨酸氨基转移酶正常'
  ,case when alt 		=1 then 1 else 0 end  alt_normal		     -- '丙氨酸氨基转移酶正常'  
  ,case when alt 		=2 then 1 else 0 end  alt_abnormal		     -- '丙氨酸氨基转移酶异常'
  ,case when size(split(lack,',')) >0 then 1 else 0 end lack		 -- '接种'
  ,case when whether_allergy =1 then 1 else 0 end whether_allergy			 --'过敏体质'
  ,case when whether_allergy =0 then 1 else 0 end no_whether_allergy		 --'非过敏体质'
  ,case when size(split(allergy_ingredients,',')) >0 then 1 else 0 end allergy_ingredients        -- '食材过敏'
  from 
  dwh_dw_campus.clife_campus_dwd_health_stu 
  where part_date=regexp_replace(date_sub(current_date(),1),'-','')
) t 
group by t.class_id


===========================
clife_campus_dws_robot_check_report
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_robot_check_report  partition(part_date)
select  
 t.class_id         -- '班级id'
,max(t.class_name)       -- '班级名称' 
,max(t.grade_id)         -- '年级id'
,max(t.grade_name)       -- '年级名称'
,max(t.org_id)           -- '学校id'
,max(t.org_name)         -- '学校名称'
,max(t.area_id)          -- '学校区县id'
,sum(t.`check`)      -- '已晨检'
,sum(t.no_check)      -- '已晨检'
,sum(t.many_check)      -- '多次晨检'
,sum(t.result_normal)              --'结果正常人数'
,sum(t.result_abnormal)            --'结果异常人数'
,sum(t.temperature_low)            -- '低温'
,sum(t.temperature_normal)         -- '正常'
,sum(t.temperature_low_fever)      -- '低热'
,sum(t.temperature_high)           -- '高热'
,sum(t.hand_normal)  -- '手部异常'
,sum(t.hand_abnormal)  -- '手部异常'
,sum(t.mouth_normal)  -- '口腔异常'
,sum(t.mouth_abnormal)  -- '口腔异常'
,sum(t.red_eye_normal)  -- '红眼'
,sum(t.red_eye_abnormal)  -- '红眼'
,sum(t.fever_normal)  -- '发烧'
,sum(t.fever_abnormal)  -- '发烧'
,sum(t.cheek_normal)  -- '腮部肿大'
,sum(t.cheek_abnormal)  -- '腮部肿大'
,sum(t.spirit_normal)  -- '精神不佳'
,sum(t.spirit_abnormal)  -- '精神不佳'
,sum(t.throat_normal)  -- '咽炎'
,sum(t.throat_abnormal)  -- '咽炎'
,sum(t.trauma_normal)  -- '外伤'
,sum(t.trauma_abnormal)  -- '外伤'
,sum(t.cough_normal)  -- '咳嗽'
,sum(t.cough_abnormal)  -- '咳嗽'
,sum(t.fingernail_normal)  -- '指甲过长'
,sum(t.fingernail_abnormal)  -- '指甲过长'
,sum(t.tooth_decay_normal)  -- '蛀牙'
,sum(t.tooth_decay_abnormal)  -- '蛀牙'
,sum(t.other_normal)  -- '其他异常'
,sum(t.other_abnormal)  -- '其他异常'
,sum(t.`access`)        -- '允许入园'
,count(t.student_id)    --'学生人数'
,regexp_replace(date_sub(current_date(),1),'-','') as part_date
from
(
select 
 a.student_id
,a.class_id         -- '班级id'
,a.class_name       -- '班级名称' 
,a.grade_id         -- '年级id'
,a.grade_name       -- '年级名称'
,a.org_id           -- '学校id'
,a.org_name         -- '学校名称'
,a.area_id          -- '学校区县id'
,case when t2.`level` =0 then 1 else 0 end temperature_low            -- '低温'
,case when t2.`level` =1 then 1 else 0 end temperature_normal         -- '正常'
,case when t2.`level` =2 then 1 else 0 end temperature_low_fever      -- '低热'
,case when t2.`level` =3 then 1 else 0 end temperature_high           -- '高热'
,case when t2.hand         =1 then 1 else 0 end   hand_normal  -- '手部异常'
,case when t2.hand         =2 then 1 else 0 end   hand_abnormal  -- '手部异常'
,case when t2.mouth        =1 then 1 else 0 end   mouth_normal  -- '口腔异常'
,case when t2.mouth        =2 then 1 else 0 end   mouth_abnormal  -- '口腔异常'
,case when t2.red_eye      =1 then 1 else 0 end   red_eye_normal  -- '红眼'
,case when t2.red_eye      =2 then 1 else 0 end   red_eye_abnormal  -- '红眼'
,case when t2.fever        =1 then 1 else 0 end   fever_normal  -- '发烧'
,case when t2.fever        =2 then 1 else 0 end   fever_abnormal  -- '发烧'
,case when t2.cheek        =1 then 1 else 0 end   cheek_normal  -- '腮部肿大'
,case when t2.cheek        =2 then 1 else 0 end   cheek_abnormal  -- '腮部肿大'
,case when t2.spirit       =1 then 1 else 0 end   spirit_normal  -- '精神不佳'
,case when t2.spirit       =2 then 1 else 0 end   spirit_abnormal  -- '精神不佳'
,case when t2.throat       =1 then 1 else 0 end   throat_normal  -- '咽炎'
,case when t2.throat       =2 then 1 else 0 end   throat_abnormal  -- '咽炎'
,case when t2.trauma       =1 then 1 else 0 end   trauma_normal  -- '外伤'
,case when t2.trauma       =2 then 1 else 0 end   trauma_abnormal  -- '外伤'
,case when t2.cough        =1 then 1 else 0 end   cough_normal  -- '咳嗽'
,case when t2.cough        =2 then 1 else 0 end   cough_abnormal  -- '咳嗽'
,case when t2.fingernail   =1 then 1 else 0 end   fingernail_normal  -- '指甲过长'
,case when t2.fingernail   =2 then 1 else 0 end   fingernail_abnormal  -- '指甲过长'
,case when t2.tooth_decay  =1 then 1 else 0 end   tooth_decay_normal  -- '蛀牙'
,case when t2.tooth_decay  =2 then 1 else 0 end   tooth_decay_abnormal  -- '蛀牙'
,case when t2.other        =1 then 1 else 0 end   other_normal  -- '其他异常'
,case when t2.other        =2 then 1 else 0 end   other_abnormal  -- '其他异常'
,case when t2.abnormal_num =0 then 1 else 0 end   result_normal   -- '结果正常'
,case when t2.abnormal_num >0 then 1 else 0 end   result_abnormal   -- '结果异常'
,case when t3.measure_cnt  >0 then 1 else 0 end   `check`      -- '已晨检'
,case when t3.measure_cnt  is null then 1 else 0 end   no_check      -- '未晨检'
,case when t3.measure_cnt  >1 then 1 else 0 end   many_check      -- '多次晨检'
,case when t2.`access`  =1 then 1 else 0 end   `access`      -- '允许入园'
from 
  dwh_dw_campus.clife_campus_dim_student a
  left join 
( 
select t1.* from 
(
select 
student_id      
,class_id         -- '班级id'
,class_name       -- '班级名称' 
,grade_id         -- '年级id'
,grade_name       -- '年级名称'
,org_id           -- '学校id'
,org_name         -- '学校名称'
,area_id          -- '学校区县id'
,`level`            -- '体温状态'
,hand             -- '手部异常'
,mouth            -- '口腔异常'
,red_eye          -- '红眼'
,fever            -- '发烧'
,cheek            -- '腮部肿大'
,spirit           -- '精神不佳'
,throat           -- '咽炎'
,trauma           -- '外伤'
,cough            -- '咳嗽'
,fingernail       -- '指甲过长'
,tooth_decay      -- '蛀牙'
,other            -- '其他异常'
,abnormal_num     -- '异常数量'
,access           -- '是否允许入园(1-是、0-否)'
,row_number() over(partition by student_id order by measure_time desc) as ranks
from dwh_dw_campus.clife_campus_dwd_robot_check_report 
where part_date=regexp_replace(date_sub(current_date(),1),'-','')
) t1
where t1.ranks=1 ) t2
on a.student_id=t2.student_id 
left join 
(
select student_id,count(data_id) as measure_cnt 
from dwh_dw_campus.clife_campus_dwd_robot_check_report 
where part_date=regexp_replace(date_sub(current_date(),1),'-','')
group by student_id
) t3 
on a.student_id=t3.student_id
where a.part_date=regexp_replace(date_sub(current_date(),1),'-','') and a.status=1 and a.deleted=1
) t  
group by t.class_id


===========================
clife_campus_dws_sleep_day_data
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_sleep_day_data  partition(part_date)
select 
   t.class_id                   -- '班级id'
  ,max(t.class_name)                 -- '班级名称'
  ,max(t.grade_id)                   -- '年级id'
  ,max(t.grade_name)                 -- '年级名称'
  ,max(t.org_id)                     -- '学校id'
  ,max(t.org_name)                   -- '学校名称'
  ,max(t.area_id) 				     -- '区县id'
  ,sum(t.sleep_duration)             -- '睡眠时长（秒）'
  ,sum(t.wake_duration)              -- '清醒时长（秒）'
  ,sum(t.wake_number)                -- '清醒次数'
  ,sum(t.score_0)         as score_0             -- '0星人数'
  ,sum(t.score_1)         as score_1             -- '1星人数'
  ,sum(t.score_2)         as score_2             -- '2星人数'
  ,sum(t.score_3)         as score_3             -- '3星人数'
  ,sum(t.score_4)         as score_4             -- '4星人数'
  ,sum(t.score_5)         as score_5             -- '5星人数'
  ,regexp_replace(date_sub(current_date(),1),'-','') as part_date
from 
(
select 
   class_id                   -- '班级id'
  ,class_name                 -- '班级名称'
  ,grade_id                   -- '年级id'
  ,grade_name                 -- '年级名称'
  ,org_id                     -- '学校id'
  ,org_name                   -- '学校名称'
  ,area_id 				     -- '区县id'
  ,sleep_duration             -- '睡眠时长（秒）'
  ,wake_duration              -- '清醒时长（秒）'
  ,wake_number                -- '清醒次数'
  ,case when score=0.0 then 1 else 0 end  as   score_0    -- '0星'
  ,case when score=1.0 then 1 else 0 end  as   score_1    -- '1星'
  ,case when score=2.0 then 1 else 0 end  as   score_2    -- '2星'
  ,case when score=3.0 then 1 else 0 end  as   score_3    -- '3星'
  ,case when score=4.0 then 1 else 0 end  as   score_4    -- '4星'
  ,case when score=5.0 then 1 else 0 end  as   score_5    -- '5星'                    -- '睡眠打分高'
from dwh_dw_campus.clife_campus_dwd_sleep_day_data t1
where t1.part_date=regexp_replace(date_sub(current_date(),1),'-','')
) t 
group by t.class_id


===========================
clife_campus_dws_sports_data
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_sports_data  partition(part_date)
select 
   t2.student_id           -- '学生唯一标识'
  ,t2.student_name              -- '姓名'
  ,t2.sex              -- '1-男 2-女 3-其他'
  ,t2.age              --  '年龄'
  ,t2.class_id              -- '班级id'
  ,t2.class_name              -- '班级名称'
  ,t2.grade_id              -- '年级id'
  ,t2.grade_name              -- '年级名称'
  ,t2.org_id              -- '学校id'
  ,t2.org_name              -- '学校名称'
  ,t2.area_id		     -- '区县id'
  ,t2.sum_step              -- '总步数'
  ,t2.is_enter              -- '是否入园'
  ,case when st.data_id is not null and t2.is_enter=1 and (t3.sport_num is null or t3.sport_num<st.standard) then 0 
        when st.data_id is not null and t2.is_enter=1 and t3.sport_num>=st.standard  and t3.sport_num<st.adequate then 1
		when st.data_id is not null and t2.is_enter=1 and t3.sport_num>=st.adequate  then 2
		when st.data_id is null and t2.is_enter=1 and (t3.sport_num is null or t3.sport_num<38000) then 0 
        when st.data_id is null and t2.is_enter=1 and t3.sport_num>=38000  and t3.sport_num<50000 then 1
		when st.data_id is null and t2.is_enter=1 and t3.sport_num>=50000   then 2
		else null end  as access_status
  ,t3.sport_num             -- '总运动量'
  ,regexp_replace(date_sub(current_date(),1),'-','')
from 
(
select
   t1.student_id        student_id           -- '学生唯一标识'
  ,max(t1.student_name) student_name              -- '姓名'
  ,max(t1.sex)          sex              -- '1-男 2-女 3-其他'
  ,max(t1.age)          age              --  '年龄'
  ,max(t1.class_id)     class_id              -- '班级id'
  ,max(t1.class_name)   class_name              -- '班级名称'
  ,max(t1.grade_id)     grade_id              -- '年级id'
  ,max(t1.grade_name)   grade_name              -- '年级名称'
  ,max(t1.org_id)       org_id              -- '学校id'
  ,max(t1.org_name)     org_name              -- '学校名称'
  ,max(t1.area_id) 		area_id		     -- '区县id'
  ,sum(t1.`value`)      sum_step              -- '总步数'
  ,max(t1.is_enter)     is_enter              -- '是否入园'
from 
(
select 
  a.student_id                 -- '学生唯一标识'
  ,a.student_name               -- '姓名'
  ,a.sex                        -- '1-男 2-女 3-其他'
  ,a.age                        --  '年龄'
  ,a.class_id                   -- '班级id'
  ,a.class_name                 -- '班级名称'
  ,a.grade_id                   -- '年级id'
  ,a.grade_name                 -- '年级名称'
  ,a.org_id                     -- '学校id'
  ,a.org_name                   -- '学校名称'
  ,a.area_id 				     -- '区县id'
  ,case when t.`value` is null then 0 else t.`value` end `value`   --'步数'
  ,case when b.student_id is null then 0 else 1 end is_enter       --'是否入园'
  from 
  dwh_dw_campus.clife_campus_dim_student a 
  left join 
  dwh_dw_campus.clife_campus_dim_into_campus_detail b 
  on a.student_id=b.student_id and b.part_date=regexp_replace(date_sub(current_date(),1),'-','') and b.am_status = 1 and b.data_time=date_sub(current_date(),1)
  left join 
  dwh_dw_campus.clife_campus_dwd_sports_record t
on a.student_id=t.student_id and   t.part_date=regexp_replace(date_sub(current_date(),1),'-','') 
where a.part_date=regexp_replace(date_sub(current_date(),1),'-','') and a.deleted=1 and a.status=1
)  t1
group by t1.student_id
) t2 
left join 
(
select student_id,sum(sport_num) as sport_num from 
dwh_dw_campus.clife_campus_dwd_sports_amount where part_date=regexp_replace(date_sub(current_date(),1),'-','')
group by student_id
) t3
on  t2.student_id=t3.student_id
left join 
dwh_dw_campus.clife_campus_dim_sports_assess_setting	st
on t2.org_id=st.org_id and t2.grade_id=st.grade_id and st.part_date=regexp_replace(date_sub(current_date(),1),'-','')


===========================
clife_campus_dws_location_stu_converge
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_location_stu_converge partition(part_date)
select
     student_id                            --'学生唯一标识'
    ,map_location_id                       --'活动位置编号'
    ,max(location_name) as  location_name  --'活动位置名称'
    ,max(`type`) as  type                  --'类型'
    ,substr(enter_time,1,10) as activity_day --活动日期
    ,max(student_name)  as student_name -- '姓名'
    ,class_id                             -- '班级id'
    ,max(class_name)    as class_name     -- '班级名称'
    ,grade_id                             -- '年级id'
    ,max(grade_name)    as grade_name     -- '年级名称'
    ,org_id                               -- '学校id'
    ,max(org_name)      as org_name       -- '学校名称'
    ,org_area_id                          -- '学校县区id'
    ,max(org_area_name) as org_area_name  -- '学校县区名称'
    ,sum(time_length) as stop_time        --'停留总时长'
    ,count(time_length) as stop_count     --'停留总次数'
    ,regexp_replace(date_sub(current_date(),1),'-','') as part_date
from dwh_dw_campus.clife_campus_dwd_location_stu
where part_date = regexp_replace(date_sub(current_date(),1),'-','')
group by student_id
        ,map_location_id
        ,substr(enter_time,1,10)
        ,class_id
        ,grade_id
        ,org_id
        ,org_area_id


===========================
clife_campus_dws_disposition_stu_converge
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_disposition_stu_converge partition(part_date)
select
     class_id -- 班级id
    ,class_name -- 班级名称
    ,grade_id-- 年级id
    ,grade_name-- 年级名称
    ,org_id-- 学校id
    ,org_name-- 学校名称
    ,org_area_id-- 学校区县id
    ,org_area_name -- 学校县区名称
    ,sub_count -- 学生人数
    ,measurement_num -- 量表测量人数
    ,disposition_num -- 绘画分析测量人数
    ,synthesis_1_introversion_num -- 综合外倾性内向人数
    ,synthesis_1_neutral_num -- 综合外倾性中性人数
    ,synthesis_1_extroversion_num -- 综合外倾性外向人数
    ,coalesce(synthesis_1_introversion_num/sub_count,0) as synthesis_1_introversion_rate-- 综合外倾性内向占比
    ,coalesce(synthesis_1_neutral_num/sub_count,0) as synthesis_1_neutral_rate-- 综合外倾性中性占比
    ,coalesce(synthesis_1_extroversion_num/sub_count,0) as synthesis_1_extroversion_rate-- 综合外倾性外向占比
    ,synthesis_5_pragmatic_num -- 综合开放性务实人数
    ,synthesis_5_neutral_num -- 综合开放性中性人数
    ,synthesis_5_create_num -- 综合开放性创造人数
    ,coalesce(synthesis_5_pragmatic_num/sub_count,0) as synthesis_5_pragmatic_rate -- 综合开放性务实占比
    ,coalesce(synthesis_5_neutral_num/sub_count,0) as synthesis_5_neutral_rate  -- 综合开放性中性占比
    ,coalesce(synthesis_5_create_num/sub_count,0) as synthesis_5_create_rate  -- 综合开放性创造占比
    ,synthesis_9_strict_num -- 综合宜人性严格人数
    ,synthesis_9_neutral_num -- 综合宜人性中性人数
    ,synthesis_9_broad_num -- 综合宜人性宽容人数
    ,coalesce(synthesis_9_strict_num/sub_count,0) as synthesis_9_strict_rate -- 综合宜人性严格占比
    ,coalesce(synthesis_9_neutral_num/sub_count,0) as synthesis_9_neutral_rate -- 综合宜人性中性占比
    ,coalesce(synthesis_9_broad_num/sub_count,0) as synthesis_9_broad_rate -- 综合宜人性宽容占比
    ,synthesis_13_casual_num  -- 综合责任心随性人数
    ,synthesis_13_neutral_num -- 综合责任心中性人数
    ,synthesis_13_order_num  -- 综合责任心有序人数
    ,coalesce(synthesis_13_casual_num/sub_count,0) as synthesis_13_casual_rate-- 综合责任心随性占比
    ,coalesce(synthesis_13_neutral_num/sub_count,0) as synthesis_13_neutral_rate-- 综合责任心中性占比
    ,coalesce(synthesis_13_order_num/sub_count,0) as synthesis_13_order_rate-- 综合责任心有序占比
    ,synthesis_17_stable_num -- 综合情绪稳定性稳定人数
    ,synthesis_17_neutral_num -- 综合情绪稳定性中性人数
    ,synthesis_17_rich_num  -- 综合情绪稳定性丰富人数
    ,coalesce(synthesis_17_stable_num/sub_count,0) as synthesis_17_stable_rate -- 综合情绪稳定性稳定占比
    ,coalesce(synthesis_17_neutral_num/sub_count,0) as synthesis_17_neutral_rate -- 综合情绪稳定性中性占比
    ,coalesce(synthesis_17_rich_num/sub_count,0) as synthesis_17_rich_rate -- 综合情绪稳定性丰富占比
    ,regexp_replace(date_sub(current_date(),1),'-','') as part_date -- 跑数时间
from
(
   select
        class_id -- 班级id
       ,max(class_name) as  class_name -- 班级名称
       ,grade_id-- 年级id
       ,max(grade_name) as grade_name-- 年级名称
       ,org_id-- 学校id
       ,max(org_name) as org_name -- 学校名称
       ,org_area_id-- 学校区县id
       ,max(org_area_name) as org_area_name -- 学校县区名称
       ,count(student_id) as sub_count-- 学生人数
       ,sum(case when mens_t_score_1 is not null or mens_t_score_5 is not null 
                    or mens_t_score_9 is not null or mens_t_score_13 is not null 
       			 or mens_t_score_17 is not null then 1 else 0 end ) as measurement_num -- 量表测量人数
       ,sum(case when mode_type_score_1 is not null or mode_type_score_5 is not null 
                    or mode_type_score_9 is not null or mode_type_score_13 is not null 
       			 or mode_type_score_17 is not null then 1 else 0 end ) as disposition_num -- 绘画分析测量人数
       ,sum(case when synthesis_score_1 is not null and synthesis_score_1 >= 0 and synthesis_score_1 <= 30  then 1 else 0 end ) as synthesis_1_introversion_num -- 综合外倾性内向人数
       ,sum(case when synthesis_score_1 is not null and synthesis_score_1 >= 31 and synthesis_score_1 <= 69 then 1 else 0 end ) as synthesis_1_neutral_num -- 综合外倾性中性人数
       ,sum(case when synthesis_score_1 is not null and synthesis_score_1 >= 70 and synthesis_score_1 <= 100 then 1 else 0 end ) as synthesis_1_extroversion_num -- 综合外倾性外向人数
       ,sum(case when synthesis_score_5 is not null and synthesis_score_5 >= 0 and synthesis_score_5 <= 30 then 1 else 0 end ) as synthesis_5_pragmatic_num  -- 综合开放性务实人数
       ,sum(case when synthesis_score_5 is not null and synthesis_score_5 >= 31 and synthesis_score_5 <= 69 then 1 else 0 end ) as synthesis_5_neutral_num  -- 综合开放性中性人数
       ,sum(case when synthesis_score_5 is not null and synthesis_score_5 >= 70 and synthesis_score_5 <= 100 then 1 else 0 end ) as synthesis_5_create_num  -- 综合开放性创造人数
       ,sum(case when synthesis_score_9 is not null and synthesis_score_9 >= 0  and synthesis_score_9 <= 30 then 1 else 0 end ) as synthesis_9_strict_num -- 综合宜人性严格人数
       ,sum(case when synthesis_score_9 is not null and synthesis_score_9 >= 31 and synthesis_score_9 <= 69 then 1 else 0 end ) as synthesis_9_neutral_num  -- 综合宜人性中性人数
       ,sum(case when synthesis_score_9 is not null and synthesis_score_9 >= 70 and synthesis_score_9 <= 100 then 1 else 0 end ) as synthesis_9_broad_num  -- 综合宜人性宽容人数
       ,sum(case when synthesis_score_13 is not null and synthesis_score_13 >= 0  and synthesis_score_13 <= 30 then 1 else 0 end ) as  synthesis_13_casual_num   -- 综合责任心随性人数
       ,sum(case when synthesis_score_13 is not null and synthesis_score_13 >= 31 and synthesis_score_13 <= 69 then 1 else 0 end ) as  synthesis_13_neutral_num  -- 综合责任心中性人数
       ,sum(case when synthesis_score_13 is not null and synthesis_score_13 >= 70 and synthesis_score_13 <= 100 then 1 else 0 end ) as synthesis_13_order_num   -- 综合责任心有序人数
       ,sum(case when synthesis_score_17 is not null and synthesis_score_17 >= 0  and synthesis_score_17 <= 30 then 1 else 0 end ) as  synthesis_17_stable_num   -- 综合情绪稳定性稳定人数
       ,sum(case when synthesis_score_17 is not null and synthesis_score_17 >= 31 and synthesis_score_17 <= 69 then 1 else 0 end ) as  synthesis_17_neutral_num  -- 综合情绪稳定性中性人数
       ,sum(case when synthesis_score_17 is not null and synthesis_score_17 >= 70 and synthesis_score_17 <= 100 then 1 else 0 end ) as synthesis_17_rich_num    -- 综合情绪稳定性丰富人数
   from dwh_dw_campus.clife_campus_dwd_disposition_stu_info
   where part_date = regexp_replace(date_sub(current_date(),1),'-','')
   group by class_id,grade_id,org_id,org_area_id
)t


===========================
clife_campus_dws_classroom_env_converge
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_classroom_env_converge partition(part_date)
select 
     grade_id    -- ’年级id'
    ,max(grade_name) as grade_name  -- '年级名称'
    ,org_id      --'学校id'
    ,max(org_name) as org_name    --'学校名称'
    ,org_area_id --'学校区县id'
    ,max(org_area_name) as org_area_name  --'学校区县名称'
    ,sum(case when intds_result = '优' then 1 else 0 end ) as intds_high_num --原水水质优数量
    ,sum(case when intds_result = '良' then 1 else 0 end ) as intds_middle_num  --原水水质良数量
    ,sum(case when intds_result = '合格' then 1 else 0 end ) as  intds_qualified_num--原水水质合格数量
    ,sum(case when intds_result = '一般' then 1 else 0 end ) as  intds_general_num--原水水质一般数量
    ,sum(case when outtds_result = '极佳' then 1 else 0 end ) as outtds_high_num --出水水质优数量
    ,sum(case when outtds_result = '优秀' then 1 else 0 end ) as outtds_middle_num  --出水水质良数量
    ,sum(case when outtds_result = '良好' then 1 else 0 end ) as  outtds_qualified_num --出水水质合格数量
    ,sum(case when outtds_result = '一般' then 1 else 0 end ) as  outtds_general_num --出水水质一般数量
    ,sum(case when outtds_result = '有待改善' then 1 else 0 end ) as  outtds_need_improve_num --出水水质有待改善数量
    ,sum(case when pm25_result = '优' then 1 else 0 end ) as  pm25_0_35_num  --PM2.5优数量
    ,sum(case when pm25_result = '良' then 1 else 0 end ) as  pm25_36_75_num  --PM2.5良数量
    ,sum(case when pm25_result = '轻度' then 1 else 0 end ) as  pm25_76_115_num  --PM2.5轻度数量
    ,sum(case when pm25_result = '中度' then 1 else 0 end ) as  pm25_116_150_num  --PM2.5中度数量
    ,sum(case when pm25_result = '重度' then 1 else 0 end ) as  pm25_151_250_num  --PM2.5重度数量
    ,sum(case when air_exhaust_result = '寒冷' then 1 else 0 end ) as  air_exhaust_5_num  --温度寒冷数量
    ,sum(case when air_exhaust_result = '较冷' then 1 else 0 end ) as  air_exhaust_6_18_num  --湿度较冷数量
    ,sum(case when air_exhaust_result = '适宜' then 1 else 0 end ) as  air_exhaust_19_28_num  --湿度适宜数量
    ,sum(case when air_exhaust_result = '较热' then 1 else 0 end ) as  air_exhaust_29_32_num  --湿度较热数量
    ,sum(case when air_exhaust_result = '炎热' then 1 else 0 end ) as  air_exhaust_33_num  --湿度炎热数量
    ,sum(case when air_exhausthum_result = '干燥' then 1 else 0 end ) as  air_exhausthum_0_40_num  --湿度干燥数量
    ,sum(case when air_exhausthum_result = '适宜' then 1 else 0 end ) as  air_exhausthum_41_75_num  --湿度适宜数量
    ,sum(case when air_exhausthum_result = '湿润' then 1 else 0 end ) as  air_exhausthum_76_100_num  --湿度湿润数量
    ,sum(case when co2_result = '优' then 1 else 0 end ) as  co2_0_450_num  --CO2优数量
    ,sum(case when co2_result = '良' then 1 else 0 end ) as  co2_451_800_num  --CO2良数量
    ,sum(case when co2_result = '轻度' then 1 else 0 end ) as  co2_801_1200_num  --CO2轻度数量
    ,sum(case when co2_result = '中度' then 1 else 0 end ) as  co2_1201_2000_num  --CO2中度数量
    ,sum(case when co2_result = '重度' then 1 else 0 end ) as  co2_2001_num  --CO2重度数量
    ,regexp_replace(date_sub(current_date(),1),'-','') as part_date
from dwh_dw_campus.clife_campus_dwd_classroom_env_info
where part_date = regexp_replace(date_sub(current_date(),1),'-','')
group by grade_id,org_id,org_area_id


===========================
clife_campus_dws_drink_water_data
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_drink_water_data  partition(part_date)
select 
   t2.student_id           -- '学生唯一标识'
  ,t2.student_name              -- '姓名'
  ,t2.sex              -- '1-男 2-女 3-其他'
  ,t2.age              --  '年龄'
  ,t2.class_id              -- '班级id'
  ,t2.class_name              -- '班级名称'
  ,t2.grade_id              -- '年级id'
  ,t2.grade_name              -- '年级名称'
  ,t2.org_id              -- '学校id'
  ,t2.org_name              -- '学校名称'
  ,t2.area_id		     -- '区县id'
  ,t2.sum_drink              -- '总飲水量'
  ,t2.no_drink              --'飲水人數' 
  ,t2.am_status              -- '是否入园'  
  ,case when t3.data_id is not null and t2.am_status=1 and (t2.sum_drink is null or t2.sum_drink<t3.standard) then 0 --'不足'
        when t3.data_id is not null and t2.am_status=1 and t2.sum_drink>=t3.standard  and t2.sum_drink<t3.enough then 1 --'达标'
		when t3.data_id is not null and t2.am_status=1 and t2.sum_drink>=t3.enough  then 2 --'充足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 0 and t2.grade_id = 5 and (t2.sum_drink is null or t2.sum_drink<4) then 0 --'托班杯数不足'
		when t3.data_id is null and t2.am_status=1  and t2.device_type = 0 and t2.grade_id = 5 and t2.sum_drink<6 and t2.sum_drink>=4 then 1 --'托班杯数达标'
		when t3.data_id is null and t2.am_status=1  and t2.device_type = 0 and t2.grade_id = 5 and  t2.sum_drink>=6  then 2 --'托班杯数充足'
		when t3.data_id is null and t2.am_status=1  and t2.device_type = 0 and t2.grade_id = 6 and (t2.sum_drink is null or t2.sum_drink<5) then 0 --'小班杯数不足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 0 and t2.grade_id = 6 and t2.sum_drink<7 and t2.sum_drink>=5 then 1 --'小班杯数达标'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 0 and t2.grade_id = 6 and t2.sum_drink>=7  then 2 --'小班杯数充足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 0 and (t2.grade_id = 7 or t2.grade_id = 8) and (t2.sum_drink is null or t2.sum_drink<6) then 0 --'中班杯数不足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 0 and (t2.grade_id = 7 or t2.grade_id = 8) and t2.sum_drink<8 and t2.sum_drink>=6 then 1 --'中班杯数达标'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 0 and (t2.grade_id = 7 or t2.grade_id = 8) and t2.sum_drink>=8  then 2 --'中班杯数充足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 0 and t2.grade_id = 9 and (t2.sum_drink is null or t2.sum_drink<8) then 0 --'学前班杯数不足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 0 and t2.grade_id = 9 and t2.sum_drink<10 and t2.sum_drink>=8 then 1 --'学前班杯数达标'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 0 and t2.grade_id = 9 and t2.sum_drink>=10  then 2 --'学班杯数充足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 5 and (t2.sum_drink is null or t2.sum_drink<400) then 0 --'托班杯数不足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 5 and t2.sum_drink<600 and t2.sum_drink>=400 then 1 --'托班杯数达标'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 5 and t2.sum_drink>=600  then 2 --'托班杯数充足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 6 and (t2.sum_drink is null or t2.sum_drink<450) then 0 --'小班杯数不足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 6 and t2.sum_drink<650 and t2.sum_drink>=450 then 1 --'小班杯数达标'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 6 and t2.sum_drink>=650  then 2 --'小班杯数充足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 7 and (t2.sum_drink is null or t2.sum_drink<550) then 0 --'小班杯数不足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 7 and t2.sum_drink<750 and t2.sum_drink>=550 then 1 --'小班杯数达标'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 7 and t2.sum_drink>=750  then 2 --'小班杯数充足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 8 and (t2.sum_drink is null or t2.sum_drink<600) then 0 --'小班杯数不足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 8 and t2.sum_drink<800 and t2.sum_drink>=600 then 1 --'小班杯数达标'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 8 and t2.sum_drink>=800  then 2 --'小班杯数充足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 9 and (t2.sum_drink is null or t2.sum_drink<750) then 0 --'学前班杯数不足'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 9 and t2.sum_drink<950 and t2.sum_drink>=750 then 1 --'学前班杯数达标'
		when t3.data_id is null and t2.am_status=1 and t2.device_type = 1 and t2.grade_id = 9 and t2.sum_drink>=950  then 2 --'学班杯数充足'
		else null 
	end  as standard_status
  ,regexp_replace(date_sub(current_date(),1),'-','')
from 
  ( 
	select
	    t1.student_id student_id
	    ,max(t1.student_name)  student_name     -- '姓名'
	    ,max(t1.sex)   sex                      -- '1-男 2-女 3-其他'
	    ,max(t1.age)    age                     -- '年龄'
	    ,max(t1.class_id)   class_id            -- '班级id'
	    ,max(t1.class_name)    class_name       -- '班级名称'
	    ,max(t1.grade_id)   grade_id            -- '年级id'
	    ,max(t1.grade_name)   grade_name        -- '年级名称'
	    ,max(t1.org_id)     org_id              -- '学校id'
	    ,max(t1.org_name)     org_name          -- '学校名称'
	    ,max(t1.area_id) 		area_id		     -- '区县id'
	    ,cast(sum(t1.water_amount) as Decimal(10,2)) sum_drink  -- '饮水总量'
	    ,count(t1.water_amount) no_drink        -- '饮水次数'
	    ,max(t1.am_status)     am_status  
	    ,max(t1.device_type)   device_type  
	from 
	   (
		select 
		  a.student_id                 -- '学生唯一标识'
		  ,a.student_name               -- '姓名'
		  ,a.sex                        -- '1-男 2-女 3-其他'
		  ,a.age                        --  '年龄'
		  ,a.class_id                   -- '班级id'
		  ,a.class_name                 -- '班级名称'
		  ,a.grade_id                   -- '年级id'
		  ,a.grade_name                 -- '年级名称'
		  ,a.org_id                     -- '学校id'
		  ,a.org_name                   -- '学校名称'
		  ,a.area_id 				     -- '区县id'
		  ,t.water_amount  
		  ,case when b.student_id is null then 0 else 1 end am_status
		  ,case when t.device_type = 4 then 0 else 1 end device_type
		from 
		  dwh_dw_campus.clife_campus_dim_student a 
		left join 
		  dwh_dw_campus.clife_campus_dim_into_campus_detail b 
		  on a.student_id=b.student_id and b.part_date=regexp_replace(date_sub(current_date(),1),'-','') and b.am_status = 1 and substr(data_time,0,10) = date_sub(current_date(),1)   
		left join 
		  dwh_dw_campus.clife_campus_dwd_water_drink_info t
		 on a.student_id=t.student_id and   t.part_date=regexp_replace(date_sub(current_date(),1),'-','') 
		where a.part_date=regexp_replace(date_sub(current_date(),1),'-','')  and a.deleted=1 and a.status=1
	 )t1
	group by t1.student_id
   )t2
left join 
dwh_dw_campus.clife_campus_dim_water_drink_setting t3
on t2.org_id=t3.org_id and t2.grade_id=t3.grade_id and t3.part_date=regexp_replace(date_sub(current_date(),1),'-','')



===========================
clife_campus_dws_thermometer_data
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_thermometer_data  partition(part_date)
select
     b.student_id          -- '学生id'  
    ,b.student_name        -- '姓名'
    ,b.sex                 -- '性别'
    ,b.age                 -- '年龄'
    ,b.class_id            -- '班级id'
    ,b.class_name          -- '班级名称'
    ,b.grade_id            -- '年级id'
    ,b.grade_name          -- '年级名称'
    ,b.org_id              -- '学校id'
    ,b.org_name            -- '学校名称'
    ,b.area_id             -- '区县id'
    ,b.no_measure          -- '测量测数'
    ,b.no_low_fever        -- '低烧次数'
    ,b.no_normal           -- '正常次数'
    ,b.no_high_fever       -- '高热次数'
    ,c.level --每天最新的状态
    ,c.value --每天最新的值
    ,regexp_replace(date_sub(current_date(),1),'-','')
from 
(
   select 
        t2.student_id student_id
       ,max(t2.student_name)  student_name     -- '姓名'
       ,max(t2.sex)   sex                      -- '1-男 2-女 3-其他'
       ,max(t2.age)    age                     -- '年龄'
       ,max(t2.class_id)   class_id            -- '班级id'
       ,max(t2.class_name)    class_name       -- '班级名称'
       ,max(t2.grade_id)   grade_id            -- '年级id'
       ,max(t2.grade_name)   grade_name        -- '年级名称'
       ,max(t2.org_id)     org_id              -- '学校id'
       ,max(t2.org_name)     org_name          -- '学校名称'
       ,max(t2.area_id) 		area_id		     -- '区县id'
       ,case when count(t2.level) is not null  then count(t2.level) else 0 end as no_measure  --测量测数
       ,sum(no_normal)     as no_normal        --'正常次数'
       ,sum(no_low_fever)  as no_low_fever     --'低热次数'
       ,sum(no_high_fever) as no_high_fever    --'高热次数'
   from
   (
     select
          t.student_id 
         ,t.student_name    -- '姓名'a
         ,t.sex               -- '1-男 2-女 3-其他'
         ,t.age             -- '年龄'
         ,t.class_id        -- '班级id'
         ,t.class_name      -- '班级名称'
         ,t.grade_id        -- '年级id'
         ,t.grade_name      -- '年级名称'
         ,t.org_id          -- '学校id'
         ,t.org_name        -- '学校名称'
         ,t.area_id	     -- '区县id'
         ,t.level 
         ,case when level = 0 or level = 1 then 1 else 0 end as  no_normal --正常次数
         ,case when level = 2 then 1 else 0 end as  no_low_fever           --'低热次数'
         ,case when level = 3 then 1 else 0 end as  no_high_fever          --'高热次数'
     from dwh_dw_campus.clife_campus_dwd_thermometer_info t
     where t.part_date=regexp_replace(date_sub(current_date(),1),'-','') 
   )t2
   group by student_id 
) b
left join 
(	 
   select b2.* 
   from 
   (
      select 
           b1.*
	      ,row_number() over(partition by student_id order by upload_time desc) as ranks
	  from dwh_dw_campus.clife_campus_dwd_thermometer_info  b1 
	  where b1.part_date=regexp_replace(date_sub(current_date(),1),'-','')
	) b2 
	where b2.ranks=1
) c on b.student_id=c.student_id


===========================
clife_campus_dws_attendance_data
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_attendance_data  partition(part_date)
 select 
   t2.class_id, --班级ID
   class_name,  --班级名称
   grade_id,  --年级ID
   grade_name, --年级名称
   org_id,   --学校ID
   org_name,  --学校名称
   area_id,   --县区ID
   case when no_student is null then 0 else no_student end as no_student, --学生人数
   case when no_attendance is null then 0 else no_attendance end as no_attendance,  --出勤人数
   case when no_absenteeism is null then 0 else no_absenteeism end as no_absenteeism,  --缺勤人数
   case when attendance is null then 0 else attendance end as attendance, --出勤率
   case when absenteeism is null then 0 else absenteeism end as absenteeism,  --缺勤率
   no_affair_leave, --事假人数
   no_sick_leave, --病假人数
   no_leave,--请假人数
   cast(no_affair_leave/no_student as Decimal(15,2)) percent_affair_leave, --事假占比
   cast(no_sick_leave/no_student as Decimal(15,2)) percent_sick_leave, --病假占比
   data_time, --数据日期
   regexp_replace(date_sub(current_date(),1),'-','')
 from 
     ( 
	   select 
		   max(t1.class_id)   class_id            -- '班级id'
		  ,max(t1.class_name) class_name       -- '班级名称'
		  ,max(t1.grade_id)   grade_id            -- '年级id'
		  ,max(t1.grade_name) grade_name        -- '年级名称'
		  ,max(t1.org_id)     org_id              -- '学校id'
		  ,max(t1.org_name)     org_name          -- '学校名称'
		  ,max(t1.area_id) 		area_id		      -- '区县id'
		  ,count(t1.no_attendance) no_attendance --出勤人数
		  ,count(t1.no_absenteeism) no_absenteeism --未入园人数
		  ,cast(count(no_attendance)/(count(no_attendance)+count(no_absenteeism)) as Decimal(15,2)) attendance    --出勤率   
		  ,cast(count(no_absenteeism)/(count(no_attendance)+count(no_absenteeism)) as Decimal(15,2)) absenteeism  --未入园率
		  ,count(no_affair_leave) no_affair_leave--事假人数
          ,count(no_sick_leave) no_sick_leave--病假人数
          ,count(no_affair_leave)+count(no_sick_leave) no_leave --请假人数
		  ,t1.data_time
		from 
			( select 
			 	  t.class_id        -- '班级id'
				  ,t.class_name      -- '班级名称'
				  ,t.grade_id        -- '年级id'
				  ,t.grade_name      -- '年级名称'
				  ,t.org_id          -- '学校id'
				  ,t.org_name        -- '学校名称'
				  ,t.area_id	     -- '区县id'
				  ,substr(t.data_time,0,10) data_time
				  ,case when `result` = 1 then 1 end as no_attendance --出勤人数
				  ,case when `result` = 2 or `result` = 5 then 1 end as no_absenteeism --未入园人数
				  ,case when `result` = 3 then 1 end as no_sick_leave --病假人数
		          ,case when `result` = 4 then 1 end as no_affair_leave --事假人数
			  from 
				 dwh_dw_campus.clife_campus_dwd_student_attendance_info t
			  where part_date = regexp_replace(date_sub(current_date(),1),'-','')
		    )t1 
		group by t1.class_id,data_time
     )t2 
     left join 
    (    
      select count(student_id) no_student,class_id
      from dwh_dw_campus.clife_campus_dim_student b 
      where b.status=1 and b.deleted=1 and  part_date = regexp_replace(date_sub(current_date(),1),'-','')
      group by class_id
    )t3
    on(t3.class_id = t2.class_id)


===========================
clife_campus_dws_inspection_stu
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_inspection_stu  partition(part_date)
select 
 t1.student_id        -- '学生id'
,t1.student_name      -- '姓名'
,t1.sex               -- '性别'
,t1.age               -- '年龄'
,t1.class_id          -- '班级id'
,t1.class_name        -- '班级名称'
,t1.grade_id          -- '年级id'
,t1.grade_name        -- '年级名称'
,t1.org_id            -- '学校id'
,t1.org_name          -- '学校名称'
,t1.org_area_id       -- '学校县区id'
,t1.am_check_cnt      -- '晨检次数'
,t1.pm_check_cnt      -- '午检次数'
,t1.inspection_date   -- '检查日期'
,t2.is_abnormal       -- '检查结果异常次数'
,t2.fever             -- '发热'
,t2.throat            -- '咽部红肿'
,t2.hfmd              -- '疑似手口足病'
,t2.abnormal_rash     -- '异常皮疹'
,t2.cough             -- '咳嗽'
,t2.runny_nose        -- '流涕'
,t2.rash              -- '皮疹'
,t2.vomit             -- '呕吐'
,t2.conjunctival      -- '结膜充血，分泌物多'
,t2.nose_bleeding     -- '流鼻血'
,t2.trauma            -- '外伤'
,t2.diarrhea          -- '腹泻'
,t2.cheek             -- '腮腺肿大' 
,t2.hand              -- '手部异常'
,t2.mouth             -- '口腔异常'
,t2.red_eye           -- '红眼'
,t2.spirit            -- '精神不佳'
,t2.fingernail        -- '指甲过长'
,t2.contagion_ids     -- '传染病ids'
,t2.influenza        -- '流行性感冒'
,t2.rubella    -- '风疹'
,t2.contagion_diarrhea          -- '感染性腹泻'
,t2.contagion_hfmd  -- '手口足病'
,t2.dysentery  -- '痢疾'
,t2.other_contagions    -- '其他传染病'
,case when t2.other_symptom='' then null else t2.other_symptom end  other_symptom    -- '其他症状'
,regexp_replace(date_sub(current_date(),1),'-','')
from 
(
select 
a.student_id         -- '学生id'
,max(a.student_name)   student_name   -- '姓名'
,max(a.sex)            sex   -- '性别'
,max(a.age)            age  -- '年龄'
,max(a.class_id)       class_id   -- '班级id'
,max(a.class_name)     class_name   -- '班级名称'
,max(a.grade_id)       grade_id   -- '年级id'
,max(a.grade_name)     grade_name   -- '年级名称'
,max(a.org_id)         org_id   -- '学校id'
,max(a.org_name)       org_name   -- '学校名称'
,max(a.org_area_id)    org_area_id   -- '学校县区id'
,count(am_check)       am_check_cnt   --'晨检次数'
,count(pm_check)       pm_check_cnt   --'午检次数'
,a.inspection_date     inspection_date  --'检查日期'
from 
(
select 
 student_id        -- '学生id'
,student_name      -- '姓名'
,sex               -- '性别'
,age               -- '年龄'
,class_id          -- '班级id'
,class_name        -- '班级名称'
,grade_id          -- '年级id'
,grade_name        -- '年级名称'
,org_id            -- '学校id'
,org_name          -- '学校名称'
,org_area_id       -- '学校县区id'
,case when type=0 then inspection_id else null end am_check   --'晨检'
,case when type=1 then inspection_id else null end pm_check   --'午检'
,inspection_date   -- '检查日期'
from dwh_dw_campus.clife_campus_dwd_inspection_stu 
where part_date=regexp_replace(date_sub(current_date(),1),'-','') and deleted=1
)  a 
group by a.student_id,a.inspection_date
)  t1 
left join 
(
select 
b.student_id
,b.inspection_date   -- '检查日期'
,sum(b.is_abnormal)   is_abnormal    -- '检查结果异常次数'
,sum(b.fever)         fever          -- '发热'
,sum(b.throat)        throat         -- '咽部红肿'
,sum(b.hfmd)          hfmd           -- '疑似手口足病'
,sum(b.abnormal_rash) abnormal_rash    -- '异常皮疹'
,sum(b.cough)         cough           -- '咳嗽'
,sum(b.runny_nose)    runny_nose    -- '流涕'
,sum(b.rash)          rash          -- '皮疹'
,sum(b.vomit)         vomit         -- '呕吐'
,sum(b.conjunctival)  conjunctival    -- '结膜充血，分泌物多'
,sum(b.nose_bleeding) nose_bleeding    -- '流鼻血'
,sum(b.trauma)        trauma    -- '外伤'
,sum(b.diarrhea)      diarrhea    -- '腹泻'
,sum(b.cheek)         cheek    -- '腮腺肿大' 
,sum(b.hand)          hand    -- '手部异常'
,sum(b.mouth)         mouth    -- '口腔异常'
,sum(b.red_eye)       red_eye    -- '红眼'
,sum(b.spirit)        spirit    -- '精神不佳'
,sum(b.fingernail)    fingernail    -- '指甲过长'
,concat_ws(',',collect_set(contagion_ids)) as contagion_ids --'传染病ids'
,sum(b.influenza)     influenza        -- '流行性感冒'
,sum(b.rubella)       rubella    -- '风疹'
,sum(b.contagion_diarrhea)  contagion_diarrhea          -- '感染性腹泻'
,sum(b.contagion_hfmd)      contagion_hfmd  -- '手口足病'
,sum(b.dysentery)           dysentery  -- '痢疾'
,sum(b.other_contagions)    other_contagions    -- '其他传染病'
,concat_ws(',',collect_set(b.other_symptom))   other_symptom  -- '其他症状'
 from (
select 
a.student_id
,a.inspection_date   -- '检查日期'
,case when a.is_abnormal =0 then 1 when a.is_abnormal =1 then 0 else 0 end   is_abnormal -- '检查结果异常次数 '
,a.fever          -- '发热'
,a.throat         -- '咽部红肿'
,a.hfmd           -- '疑似手口足病'
,a.abnormal_rash    -- '异常皮疹'
,a.cough           -- '咳嗽'
,a.runny_nose    -- '流涕'
,a.rash          -- '皮疹'
,a.vomit         -- '呕吐'
,a.conjunctival    -- '结膜充血，分泌物多'
,a.nose_bleeding    -- '流鼻血'
,a.trauma    -- '外伤'
,a.diarrhea    -- '腹泻'
,a.cheek    -- '腮腺肿大' 
,a.hand    -- '手部异常'
,a.mouth    -- '口腔异常'
,a.red_eye    -- '红眼'
,a.spirit    -- '精神不佳'
,a.fingernail    -- '指甲过长'
,a.contagions as contagion_ids   --'传染病ids'
,a.influenza        -- '流行性感冒'
,a.rubella    -- '风疹'
,a.contagion_diarrhea          -- '感染性腹泻'
,a.contagion_hfmd  -- '手口足病'
,a.dysentery  -- '痢疾'
,a.other_contagions    -- '其他传染病'
,a.other_symptom  -- '其他症状'
,row_number() over(partition by student_id,type,inspection_date order by update_time desc) as ranks
 from dwh_dw_campus.clife_campus_dwd_inspection_stu a
 where part_date=regexp_replace(date_sub(current_date(),1),'-','') and deleted=1 ) b where b.ranks=1
 group by b.student_id,b.inspection_date
)  t2
on t1.student_id=t2.student_id and t1.inspection_date=t2.inspection_date


===========================
clife_campus_dws_medicine_data
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_medicine_data partition(part_date)
select 
    class_id                                                                   ,  -- 班级id
    max(class_name               )               as class_name                 ,  -- 班级名称
    max(grade_id                 )               as grade_id                   ,  -- 年级id
    max(grade_name               )               as grade_name                 ,  -- 年级名称
    max(org_id                   )               as org_id                     ,  -- 学校id
    max(org_name                 )               as org_name                   ,  -- 学校名称
    max(area_id                  )               as area_id                    ,  -- 学校区县id
    sum(uncomplete_medicine_cnt  )               as uncomplete_medicine_cnt    ,  -- 班级未喂药次数（人次）                       
    sum(complete_medicine_cnt    )               as complete_medicine_cnt      ,  -- 班级已喂药次数（人次）                       
    sum(total_cnt                )               as total_cnt                  ,  -- 班级总共喂药次数（人次）                       
    sum(am_cnt                   )               as am_cnt                     ,  -- 班级早上喂药次数（人次）                     
    sum(mid_cnt                  )               as mid_cnt                    ,  -- 班级中午喂药次数（人次）
    count(student_id)                            as medicine_person_cnt        ,  -- 班级喂药总人数（包含未喂药和已喂药状态）
    sum(case am_status when 0 then 1 else 0 end) as medicine_person_in_cnt     ,  -- 班级喂药总人数（包含未喂药和已喂药状态，未入园）       
    sum(case am_status when 1 then 1 else 0 end) as medicine_person_out_cnt    ,  -- 班级喂药总人数（包含未喂药和已喂药状态，已入园）       
    medication_part_date                                                       ,  -- 跑数日期
    part_date       -- 跑数日期
from dwh_dw_campus.clife_campus_dwd_medicine_data 
where part_date = regexp_replace(date_sub(current_date(),1),'-','')
group by class_id, medication_part_date,part_date


===========================
clife_campus_dws_intocampus_data
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_intocampus_data  partition(part_date)
select
 a.class_id      -- '班级id'
,a.class_name    -- '班级名称'
,a.grade_id      -- '年级id'
,a.grade_name    -- '年级名称'
,a.org_id        -- '学校id'
,a.org_name      -- '学校名称'
,a.area_id	   -- '区县id'
,coalesce(b.student_cnt,0)  as student_cnt     --班级总学生人数
,a.intocampus_num    --入园人数 
,a.no_intocampus_num --未入园人数 
,coalesce(a.intocampus_num/b.student_cnt,0)    as intocampus_rate    --入园率
,coalesce(a.no_intocampus_num/b.student_cnt,0) as no_intocampus_rate   --未入园率
,a.affair_leave_num  --请事假人数
,a.sick_leave_num    --请病假人数
,coalesce(a.sick_leave_num+a.affair_leave_num,0)  as leave_num         --请假人数
,coalesce(a.affair_leave_num/b.student_cnt,0)     as affair_leave_rate --请事假人数占比
,coalesce(a.sick_leave_num/b.student_cnt,0)       as sick_leave_rate   --请病假人数占比
,a.data_time  --数据日期
,regexp_replace(date_sub(current_date(),1),'-','') as part_date
from 
( 
  select 
       t.class_id                         -- '班级id'
      ,max(t.class_name) as class_name    -- '班级名称'
      ,max(t.grade_id)   as grade_id      -- '年级id'
      ,max(t.grade_name) as grade_name    -- '年级名称'
      ,max(t.org_id)     as org_id        -- '学校id'
      ,max(t.org_name)   as org_name      -- '学校名称'
      ,max(t.area_id)    as area_id		  -- '区县id'
      ,substr(t.data_time,0,10) data_time
      ,sum(case when att_status = 0 then 1 else 0 end) as no_intocampus_num   --未入园人数
      ,sum(case when att_status = 1 then 1 else 0 end) as intocampus_num      --入园人数
      ,sum(case when att_status = 2 then 1 else 0 end) as sick_leave_num      --病假人数
      ,sum(case when att_status = 3 then 1 else 0 end) as affair_leave_num    --事假人数
  from dwh_dw_campus.clife_campus_dwd_student_intocampus_info t
  where part_date = regexp_replace(date_sub(current_date(),1),'-','')
  group by t.class_id
          ,substr(t.data_time,0,10)
)a 
left join 
(    
  select 
       count(student_id) as student_cnt
      ,class_id
  from dwh_dw_campus.clife_campus_dim_student b 
  where b.status=1 
    and b.deleted = 1 
    and part_date = regexp_replace(date_sub(current_date(),1),'-','')
  group by class_id
)b on a.class_id = b.class_id


===========================
clife_campus_dws_shit_data
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_shit_data partition(part_date)
select
     class_id        --班级id
    ,class_name      --班级名称
    ,grade_id        --年级id
    ,grade_name      --年级名称
    ,org_id          --学校id
    ,org_name        --学校名称
    ,area_id         --学校区县id
    ,student_cnt     --班级总人数
    ,shit_num        --拉臭臭人数
    ,(student_cnt-shit_num) as no_shit_num --未拉臭臭人数
    ,into_campus_num    --入园人数
    ,no_into_campus_num --未入园人数
    ,date_time          --测量时间
    ,regexp_replace(date_sub(current_date(),1),'-','')  as part_date
from
(
  select
       a.class_id                         --班级id
      ,max(a.class_name) as class_name    --班级名称
      ,max(a.grade_id)   as grade_id      --年级id
      ,max(a.grade_name) as grade_name    --年级名称
      ,max(a.org_id)     as org_id        --学校id
      ,max(a.org_name)   as org_name      --学校名称
      ,max(a.area_id)    as area_id       --学校区县id
      ,max(b.student_cnt) as student_cnt  --班级总人数
      ,sum(case when a.shit_cnt is not null or a.shit_cnt != 0 then 1 else 0 end ) as shit_num --拉臭臭人数
      ,sum(case when a.att_status = 1 then 1 else 0 end ) as into_campus_num --入园人数
      ,sum(case when a.att_status = 0 then 1 else 0 end ) as no_into_campus_num --未入园人数
      ,a.date_time  --测量时间
  from dwh_dw_campus.clife_campus_dwd_student_shit_info a
  left join
  (
     select 
         class_id
        ,count(student_id) as student_cnt
    from dwh_dw_campus.clife_campus_dim_student 
    where status=1 
      and deleted = 1 
      and part_date = regexp_replace(date_sub(current_date(),1),'-','')
    group by class_id
  )b on a.class_id = b.class_id
  where a.part_date = regexp_replace(date_sub(current_date(),1),'-','') 
  group by a.class_id
          ,a.date_time
)e


===========================
clife_campus_dws_push_message_data
===========================
insert overwrite table dwh_dw_campus.clife_campus_dws_push_message_data partition(part_date)
select
     class_id                            --班级id
    ,class_name                          --班级名称
    ,grade_id                            --年级id
    ,grade_name                          --年级名称
    ,org_id                              --学校id
    ,org_name                            --学校名称
    ,area_id                             --学校区县id
    ,message_cnt                         --消息总数
    ,user_num                            --推送用户次数
    ,user_cnt                            --推送用户人数
    ,parents_num                         --推送家长次数
    ,parents_cnt                         --推送家长人数
    ,student_cnt                         --学生人数
    ,read_num                            --推送消息已读数
    ,no_read_num                         --推送消息未读数
    ,delete_num                          --推送消息删除数
    ,ordinary_num                        --普通推送消息数
    ,gardener_num                        --园丁端老师推送数
    ,campus_num                          --校园运营端数
    ,user_child_leave_num                --用户幼儿请假消息数
    ,parents_child_leave_num             --家长幼儿请假消息数
    ,inspection_num                      --幼儿晨午检消息数
    ,child_report_num                    --宝宝报告消息数
    ,device_num                          --智能设备管理消息数
    ,teacher_incampus_num                --教职工出勤消息数
    ,user_child_medicine_num             --用户幼儿喂药消息数
    ,parents_child_medicine_num          --家长幼儿喂药消息数
    ,child_incampus_num                  --幼儿入园出勤消息数
    ,electronic_fence_num                --电子围栏消息数
    ,parent_child_task_num               --亲子任务消息数
    ,(user_cnt+parents_cnt) as push_all_num                                     --推送总人数
    ,(user_child_leave_num+parents_child_leave_num) as child_leave_num          --幼儿请假消息数
    ,(user_child_medicine_num+parents_child_medicine_num) as child_medicine_num --幼儿喂药消息数
    ,regexp_replace(date_sub(current_date(),1),'-','') as part_date             --分区时间
from
(
  select
       t.class_id                         --班级id
      ,max(t.class_name) as class_name    --班级名称
      ,t.grade_id      --年级id
      ,max(t.grade_name) as grade_name    --年级名称
      ,t.org_id        --学校id
      ,max(t.org_name)   as org_name      --学校名称
      ,max(t1.area_id) as area_id       --学校区县id
      ,count(distinct t.message_id) as message_cnt --消息总数
      ,sum(case when user_type=1 or user_type=3 then 1 else 0 end) as user_num --推送用户次数
      ,count(distinct(case when user_type=1 or user_type=3 then user_id else null end)) as user_cnt --推送用户人数
      ,sum(case when user_type=2 then 1 else 0 end) as parents_num --推送家长次数
      ,count(distinct(case when user_type=2 then user_id else null end)) as parents_cnt --推送家长人数
      ,count(distinct student_id) as student_cnt --学生人数
      ,sum(case when t.status=2 then 1 else 0 end )as read_num --推送消息已读数
      ,sum(case when t.status=1 then 1 else 0 end )as no_read_num --推送消息未读数
      ,sum(case when t.status=0 then 1 else 0 end )as delete_num --推送消息删除数
      ,sum(case when t.data_flag=0 then 1 else 0 end )as ordinary_num --普通推送消息数
      ,sum(case when t.data_flag=1 then 1 else 0 end )as gardener_num --园丁端老师推送数
      ,sum(case when t.data_flag=2 then 1 else 0 end )as campus_num --校园运营端数
      ,count(distinct(case when t.message_type = 41000  and t.user_type = 1 then message_id else null end)) as user_child_leave_num    --用户幼儿请假消息数
      ,count(distinct(case when t.message_type = 41000  and t.user_type = 2 then message_id else null end)) as parents_child_leave_num --家长幼儿请假消息数
      ,count(distinct(case when t.message_type = 1141   and t.user_type = 2 then message_id else null end)) as inspection_num          --幼儿晨午检消息数
      ,count(distinct(case when t.message_type = 60000  and t.user_type = 2 then message_id else null end)) as child_report_num        --宝宝报告消息数
      ,count(distinct(case when t.message_type = 400    and t.user_type = 1 then message_id else null end)) as device_num              --智能设备管理消息数
      ,count(distinct(case when t.message_type = 62000  and t.user_type = 1 then message_id else null end)) as teacher_incampus_num    --教职工出勤消息数
      ,count(distinct(case when t.message_type = 15600  and t.user_type = 1 then message_id else null end)) as user_child_medicine_num    --用户幼儿喂药消息数
      ,count(distinct(case when t.message_type = 15600  and t.user_type = 2 then message_id else null end)) as parents_child_medicine_num --家长幼儿喂药消息数
      ,count(distinct(case when t.message_type = 110000 and t.user_type = 2 then message_id else null end)) as child_incampus_num         --幼儿入园出勤消息数
      ,count(distinct(case when t.message_type = 63000  and t.user_type = 1 then message_id else null end)) as electronic_fence_num       --电子围栏消息数
      ,count(distinct(case when t.message_type = 170000 and t.user_type = 2 then message_id else null end)) as parent_child_task_num      --亲子任务消息数
  from
  (
    select
         data_id         --   '自增主键'
        ,user_id         --   '用户id'
        ,user_name       --   '用户名'
        ,student_id      --   '学生id'
        ,student_name    --   '学生名'
        ,org_id          --   '机构id'
        ,message_id      --   '消息id'
        ,status          --   '消息状态（0-删除，1-未读，2-已读）'
        ,user_type       --   '用户类型'
        ,create_time     --   '创建时间'
        ,update_time     --   '更新时间'
        ,org_name        --   '学校名称'
        ,ip.grade_idi   as grade_id    --   '年级'
        ,ip.grade_namei as grade_name  --   '年级名称'
        ,ip.class_idi   as class_id    --   '班级'
        ,ip.class_namei as class_name  --   '班级名称'
        ,data_flag
        ,message_type
    from dwh_dw_campus.clife_campus_dwd_push_message_info
    lateral view explodemulti(if(grade_id is null,'',grade_id),if(grade_name is null,'',grade_name),if(class_id is null,'',class_id),if(class_name is null,'',class_name)) ip as grade_idi,grade_namei,class_idi,class_namei
    where part_date=regexp_replace(date_sub(current_date(),1),'-','')
      and(user_type = 1 or user_type = 3)
    union all
    select
         data_id         --   '自增主键'
        ,user_id         --   '用户id'
        ,user_name       --   '用户名'
        ,student_id      --   '学生id'
        ,student_name    --   '学生名'
        ,org_id          --   '机构id'
        ,message_id      --   '消息id'
        ,status          --   '消息状态（0-删除，1-未读，2-已读）'
        ,user_type       --   '用户类型'
        ,create_time     --   '创建时间'
        ,update_time     --   '更新时间'
        ,org_name        --   '学校名称'
        ,grade_id        --   '年级'
        ,grade_name      --   '年级名称'
        ,class_id        --   '班级'
        ,class_name      --   '班级名称'
        ,data_flag
        ,message_type
    from dwh_dw_campus.clife_campus_dwd_push_message_info
    where part_date=regexp_replace(date_sub(current_date(),1),'-','')
      and user_type = 2
  )t 
  left join dwh_dw_campus.clife_campus_dim_org t1 on t.org_id = t1.org_id and t1.part_date = regexp_replace(date_sub(current_date(),1),'-','')
  group by t.class_id
          ,t.grade_id
          ,t.org_id
)tp


